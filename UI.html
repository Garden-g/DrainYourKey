import React, { useState, useEffect, useRef } from 'react';
import { 
  Image as ImageIcon, 
  Video, 
  Sparkles, 
  Upload, 
  Search, 
  Download,
  ArrowRight,
  Film,
  X,
  Loader2,
  Plus,
  Sun,
  Moon,
  Monitor,
  Wand2,
  Check
} from 'lucide-react';

// --- Constants ---

const IMG_ASPECT_RATIOS = ["1:1", "2:3", "3:2", "3:4", "4:3", "4:5", "5:4", "9:16", "16:9", "21:9"];
const VID_ASPECT_RATIOS = ["16:9", "9:16"];

const IMG_RESOLUTIONS = ["1K", "2K", "4K"];
const VID_RESOLUTIONS = [
  { label: "720p (默认)", value: "720p" },
  { label: "1080p (仅支持 8 秒)", value: "1080p" },
  { label: "4k (仅支持 8 秒)", value: "4k" }
];

// --- Components ---

const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, icon: Icon }) => {
  const baseStyle = "px-4 py-2.5 rounded-lg font-medium text-sm transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95";
  
  const variants = {
    // Light: Blue brand color | Dark: White
    primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-md shadow-blue-500/20 dark:bg-white dark:text-black dark:hover:bg-zinc-200 dark:shadow-none",
    // Light: White surface with border | Dark: Zinc surface
    secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 hover:text-slate-900 dark:bg-zinc-800 dark:text-zinc-100 dark:border-zinc-700 dark:hover:bg-zinc-700",
    ghost: "bg-transparent hover:bg-slate-100 text-slate-500 hover:text-slate-900 dark:hover:bg-zinc-800 dark:text-zinc-400 dark:hover:text-zinc-100",
    outline: "border border-slate-200 text-slate-600 hover:border-blue-500 hover:text-blue-600 dark:border-zinc-700 dark:text-zinc-300 dark:hover:border-zinc-500 dark:hover:text-white bg-transparent"
  };

  return (
    <button 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyle} ${variants[variant]} ${className}`}
    >
      {Icon && <Icon size={16} />}
      {children}
    </button>
  );
};

const Select = ({ label, value, onChange, options, placeholder = "请选择..." }) => (
  <div className="flex flex-col gap-2 w-full">
    {label && <label className="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest">{label}</label>}
    <div className="relative group">
      <select 
        value={value} 
        onChange={(e) => onChange(e.target.value)}
        className="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 text-slate-900 dark:text-zinc-200 text-sm rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-white focus:border-transparent block p-2.5 appearance-none hover:border-blue-400 dark:hover:border-zinc-600 transition-colors outline-none cursor-pointer shadow-sm"
      >
        <option value="" disabled>{placeholder}</option>
        {options.map((opt) => {
          const isObj = typeof opt === 'object';
          return (
            <option key={isObj ? opt.value : opt} value={isObj ? opt.value : opt}>
              {isObj ? opt.label : opt}
            </option>
          );
        })}
      </select>
      <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-400 dark:text-zinc-600">
        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
      </div>
    </div>
  </div>
);

const NumberInput = ({ label, value, onChange, min, max }) => (
  <div className="flex flex-col gap-2 w-full">
    {label && <label className="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest">{label}</label>}
    <input
      type="number"
      min={min}
      max={max}
      value={value}
      onChange={(e) => {
        let val = parseInt(e.target.value);
        if (isNaN(val)) val = min;
        if (val > max) val = max;
        if (val < min) val = min;
        onChange(val);
      }}
      className="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 text-slate-900 dark:text-zinc-200 text-sm rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-white focus:border-transparent block p-2.5 hover:border-blue-400 dark:hover:border-zinc-600 transition-colors outline-none shadow-sm"
    />
  </div>
);

const FileUpload = ({ label, onFileSelect, preview, onClear }) => {
  const inputRef = useRef(null);

  const handleFile = (e) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      const url = URL.createObjectURL(file);
      onFileSelect({ file, url });
    }
  };

  return (
    <div className="flex flex-col gap-2">
      <label className="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest">{label}</label>
      
      {!preview ? (
        <div 
          onClick={() => inputRef.current.click()}
          className="border border-dashed border-slate-300 dark:border-zinc-700 rounded-xl p-6 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 dark:hover:border-zinc-400 hover:bg-blue-50 dark:hover:bg-zinc-800/50 transition-all group h-28 bg-white dark:bg-zinc-900/30"
        >
          <div className="p-2 rounded-full bg-slate-50 dark:bg-zinc-800 group-hover:bg-white dark:group-hover:bg-zinc-700 transition-colors mb-2 shadow-sm">
            <Plus className="text-slate-400 dark:text-zinc-400 group-hover:text-blue-600 dark:group-hover:text-zinc-200 transition-colors" size={16} />
          </div>
          <span className="text-xs text-slate-500 dark:text-zinc-500 group-hover:text-slate-700 dark:group-hover:text-zinc-300 transition-colors">选择参考图</span>
          <input ref={inputRef} type="file" accept="image/*" className="hidden" onChange={handleFile} />
        </div>
      ) : (
        <div className="relative group rounded-xl overflow-hidden border border-slate-200 dark:border-zinc-700 h-28 bg-slate-50 dark:bg-zinc-900 shadow-sm">
          <img src={preview} alt="Upload" className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" />
          <button 
            onClick={onClear}
            className="absolute top-2 right-2 p-1.5 bg-white/90 dark:bg-black/80 hover:bg-red-50 dark:hover:bg-red-900/50 hover:text-red-600 dark:hover:text-red-400 rounded-md text-slate-600 dark:text-zinc-300 shadow-sm transition-all"
          >
            <X size={12} />
          </button>
        </div>
      )}
    </div>
  );
};

// --- Prompt Assist Modal ---

const PromptAssistModal = ({ isOpen, onClose, onApply }) => {
  const [input, setInput] = useState("");
  const [isProcessing, setIsProcessing] = useState(false);

  useEffect(() => {
    if (isOpen) setInput("");
  }, [isOpen]);

  const handleEnhance = () => {
    if (!input.trim()) return;
    setIsProcessing(true);
    // Simulate AI API call
    setTimeout(() => {
      const enhanced = `High quality, highly detailed masterpiece of ${input}, cinematic lighting, 8k resolution, trending on artstation, photorealistic textures, dramatic atmosphere.`;
      onApply(enhanced);
      setIsProcessing(false);
      onClose();
    }, 1500);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/20 dark:bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-white dark:bg-zinc-900 w-full max-w-md rounded-2xl shadow-2xl border border-white/20 dark:border-zinc-800 p-6 transform transition-all scale-100">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-semibold text-slate-900 dark:text-white flex items-center gap-2">
            <Sparkles className="text-blue-500" size={18} />
            AI 提示词优化
          </h3>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
            <X size={18} />
          </button>
        </div>
        
        <p className="text-sm text-slate-500 dark:text-zinc-400 mb-4">
          输入一个简单的想法，Gemini 将为您扩写成适合生成的详细描述性提示词。
        </p>

        <textarea
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="例如：一只在太空中的猫..."
          className="w-full h-32 bg-slate-50 dark:bg-zinc-950 border border-slate-200 dark:border-zinc-800 rounded-xl p-3 text-sm text-slate-900 dark:text-zinc-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none mb-4"
          autoFocus
        />

        <div className="flex justify-end gap-2">
          <Button variant="ghost" onClick={onClose}>取消</Button>
          <Button onClick={handleEnhance} disabled={!input.trim() || isProcessing}>
            {isProcessing ? <Loader2 className="animate-spin" size={16} /> : <Wand2 size={16} />}
            {isProcessing ? "魔法生成中..." : "优化"}
          </Button>
        </div>
      </div>
    </div>
  );
};

// --- Main App Component ---

export default function App() {
  const [activeTab, setActiveTab] = useState('image'); 
  const [isSidebarOpen, setSidebarOpen] = useState(true);
  
  // Theme State
  const [isDark, setIsDark] = useState(true);

  // --- Image Gen State ---
  const [imgPrompt, setImgPrompt] = useState("");
  const [imgCount, setImgCount] = useState(2);
  const [imgRatio, setImgRatio] = useState("3:2");
  const [imgRes, setImgRes] = useState("2K");
  const [useGoogleSearch, setUseGoogleSearch] = useState(false);
  const [imgReference, setImgReference] = useState(null);
  const [isGeneratingImg, setIsGeneratingImg] = useState(false);
  const [generatedImages, setGeneratedImages] = useState([]);

  // --- Video Gen State ---
  const [videoMode, setVideoMode] = useState('text2vid');
  const [vidPrompt, setVidPrompt] = useState("");
  const [vidRes, setVidRes] = useState("720p");
  const [vidRatio, setVidRatio] = useState("16:9");
  const [vidFirstFrame, setVidFirstFrame] = useState(null);
  const [vidLastFrame, setVidLastFrame] = useState(null);
  const [isGeneratingVid, setIsGeneratingVid] = useState(false);
  const [generatedVideo, setGeneratedVideo] = useState(null);

  // --- AI Assist State ---
  const [isAssistOpen, setIsAssistOpen] = useState(false);

  // --- Handlers ---

  const handleGenerateImage = () => {
    if (!imgPrompt && !imgReference) return;
    setIsGeneratingImg(true);
    
    setTimeout(() => {
      const newImages = Array.from({ length: imgCount }).map((_, i) => ({
        id: Date.now() + i,
        url: `https://picsum.photos/seed/${Date.now() + i}/800/600`, 
        ratio: imgRatio,
        prompt: imgPrompt
      }));
      setGeneratedImages(prev => [...newImages, ...prev]);
      setIsGeneratingImg(false);
    }, 2000);
  };

  const handleGenerateVideo = () => {
    if (!vidPrompt && videoMode === 'text2vid') return;
    setIsGeneratingVid(true);
    setGeneratedVideo(null); 

    setTimeout(() => {
      setGeneratedVideo({
        id: Date.now(),
        url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
        prompt: vidPrompt,
        resolution: vidRes,
        ratio: vidRatio
      });
      setIsGeneratingVid(false);
    }, 3500);
  };

  const transferToVideo = (imgUrl) => {
    setActiveTab('video');
    setVideoMode('first_last');
    setVidFirstFrame({ url: imgUrl });
  };

  const handleAssistApply = (enhancedPrompt) => {
    if (activeTab === 'image') {
      setImgPrompt(enhancedPrompt);
    } else {
      setVidPrompt(enhancedPrompt);
    }
  };

  return (
    <div className={`${isDark ? 'dark' : ''} h-screen w-full transition-colors duration-300`}>
      <PromptAssistModal 
        isOpen={isAssistOpen} 
        onClose={() => setIsAssistOpen(false)} 
        onApply={handleAssistApply} 
      />

      <div className="flex h-full bg-slate-50 dark:bg-black text-slate-900 dark:text-zinc-200 font-sans overflow-hidden antialiased selection:bg-blue-100 dark:selection:bg-zinc-800">
        
        {/* Sidebar Navigation */}
        <div className={`${isSidebarOpen ? 'w-64' : 'w-18'} bg-white dark:bg-black border-r border-slate-200 dark:border-zinc-800 flex flex-col transition-all duration-300 z-20`}>
          
          {/* Logo Area */}
          <div className="h-16 flex items-center justify-center border-b border-slate-100 dark:border-zinc-900">
             {isSidebarOpen ? (
               <span className="font-bold tracking-tight text-xl flex items-center gap-2 text-slate-900 dark:text-white">
                 <div className="w-5 h-5 bg-blue-600 rounded-md"></div>
                 Gemini<span className="text-slate-400 dark:text-zinc-600">3</span>
               </span>
             ) : (
               <div className="w-6 h-6 bg-blue-600 rounded-md"></div>
             )}
          </div>

          <nav className="flex-1 p-3 space-y-1 mt-4">
            <NavButton 
              active={activeTab === 'image'} 
              onClick={() => setActiveTab('image')} 
              icon={ImageIcon} 
              label="图像生成" 
              expanded={isSidebarOpen} 
            />
            <NavButton 
              active={activeTab === 'video'} 
              onClick={() => setActiveTab('video')} 
              icon={Video} 
              label="视频生成" 
              expanded={isSidebarOpen} 
            />
          </nav>

          {/* Theme Toggle & Collapse */}
          <div className="p-3 border-t border-slate-100 dark:border-zinc-900 space-y-2">
             
             {isSidebarOpen ? (
               <button 
                onClick={() => setIsDark(!isDark)}
                className="w-full flex items-center justify-between p-2.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-zinc-900 text-slate-600 dark:text-zinc-400 hover:text-blue-600 dark:hover:text-white hover:bg-blue-50 dark:hover:bg-zinc-800 transition-colors"
               >
                 <span className="flex items-center gap-3">
                   {isDark ? <Moon size={16} /> : <Sun size={16} />}
                   {isDark ? '深色模式' : '浅色模式'}
                 </span>
               </button>
             ) : (
               <button 
                onClick={() => setIsDark(!isDark)}
                className="w-full flex items-center justify-center p-2.5 rounded-lg bg-slate-100 dark:bg-zinc-900 text-slate-600 dark:text-zinc-400 hover:text-blue-600 dark:hover:text-white hover:bg-blue-50 dark:hover:bg-zinc-800 transition-colors"
               >
                 {isDark ? <Moon size={18} /> : <Sun size={18} />}
               </button>
             )}

             <button 
               onClick={() => setSidebarOpen(!isSidebarOpen)}
               className="w-full flex items-center justify-center p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-zinc-900 text-slate-400 dark:text-zinc-500 hover:text-slate-900 dark:hover:text-zinc-300 transition-colors"
             >
               {isSidebarOpen ? <ArrowRight className="rotate-180" size={16} /> : <ArrowRight size={16} />}
             </button>
          </div>
        </div>

        {/* Main Content Area */}
        <main className="flex-1 flex flex-col min-w-0">
          
          {/* Header */}
          <header className="h-16 border-b border-slate-200 dark:border-zinc-800 bg-white/80 dark:bg-black/80 backdrop-blur-md flex items-center justify-between px-8 sticky top-0 z-10">
            <div>
              <h1 className="text-base font-semibold text-slate-900 dark:text-zinc-100">
                {activeTab === 'image' ? '图像工作室' : '视频工作室'}
              </h1>
              <p className="text-xs text-slate-400 dark:text-zinc-500 font-medium">
                Gemini 3.0 Pro API <span className="mx-1">•</span> 已连接
              </p>
            </div>
            
            <div className="flex items-center gap-4">
               <div className="hidden md:flex items-center gap-2 text-xs font-mono text-slate-400 dark:text-zinc-600 bg-slate-100 dark:bg-zinc-900 px-3 py-1.5 rounded-full">
                 <Monitor size={12} />
                 <span> 系统就绪 </span>
               </div>
               <div className="w-8 h-8 rounded-full bg-slate-200 dark:bg-zinc-800 border border-slate-300 dark:border-zinc-700"></div>
            </div>
          </header>

          {/* Content Scrollable */}
          <div className="flex-1 overflow-y-auto p-4 lg:p-8 scrollbar-hide">
            
            <div className="max-w-[1600px] mx-auto flex flex-col lg:flex-row gap-8 h-full">
              
              {/* LEFT PANEL: INPUTS */}
              <div className="w-full lg:w-[380px] shrink-0 flex flex-col gap-6">
                
                <div className="flex flex-col gap-6">
                  
                  {/* PROMPT INPUT */}
                  <div className="relative group">
                    <div className="flex justify-between items-center mb-2">
                      <label className="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest">描述词</label>
                      <span className="text-[10px] text-slate-400 dark:text-zinc-600 font-mono">0/2000</span>
                    </div>
                    <textarea 
                      value={activeTab === 'image' ? imgPrompt : vidPrompt}
                      onChange={(e) => activeTab === 'image' ? setImgPrompt(e.target.value) : setVidPrompt(e.target.value)}
                      placeholder={activeTab === 'image' 
                        ? "在此输入您的创意描述..." 
                        : "描述视频的动作和场景..."}
                      className="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 rounded-xl p-4 text-sm text-slate-900 dark:text-zinc-200 placeholder-slate-400 dark:placeholder-zinc-600 focus:ring-2 focus:ring-blue-500/50 dark:focus:ring-white focus:border-blue-500 dark:focus:border-transparent outline-none resize-none h-40 transition-all font-normal leading-relaxed shadow-sm hover:border-slate-300 dark:hover:border-zinc-700"
                    />
                    <div className="absolute bottom-3 right-3">
                       <button 
                        onClick={() => setIsAssistOpen(true)}
                        className="p-2 bg-slate-50 dark:bg-zinc-800 hover:bg-blue-100 hover:text-blue-600 dark:hover:bg-zinc-700 rounded-lg text-slate-500 dark:text-zinc-400 transition-all shadow-sm group-hover:shadow-md" 
                        title="AI 提示词优化"
                       >
                         <Sparkles size={14} className="group-hover:scale-110 transition-transform" />
                       </button>
                    </div>
                  </div>

                  {/* --- IMAGE CONTROLS --- */}
                  {activeTab === 'image' && (
                    <div className="space-y-6">
                       <div className="grid grid-cols-2 gap-4">
                         <Select 
                           label="宽高比" 
                           value={imgRatio} 
                           onChange={setImgRatio} 
                           options={IMG_ASPECT_RATIOS} 
                         />
                         <Select 
                           label="分辨率" 
                           value={imgRes} 
                           onChange={setImgRes} 
                           options={IMG_RESOLUTIONS} 
                         />
                       </div>

                       <div className="grid grid-cols-2 gap-4 items-end">
                          <NumberInput 
                            label="生成数量 (Max 10)"
                            min={1}
                            max={10}
                            value={imgCount}
                            onChange={setImgCount}
                          />
                          
                          <div 
                            className={`h-[42px] border rounded-lg px-3 flex items-center justify-between cursor-pointer transition-all shadow-sm ${useGoogleSearch ? 'bg-blue-600 border-blue-600 text-white dark:bg-white dark:border-white dark:text-black' : 'bg-white border-slate-200 text-slate-500 hover:border-blue-400 hover:text-slate-700 dark:bg-zinc-900 dark:border-zinc-800 dark:text-zinc-400'}`} 
                            onClick={() => setUseGoogleSearch(!useGoogleSearch)}
                          >
                             <span className="text-xs font-medium flex items-center gap-2">
                               <Search size={14} />
                               谷歌搜索
                             </span>
                             <div className={`flex items-center justify-center w-4 h-4 rounded-full ${useGoogleSearch ? 'bg-white text-blue-600 dark:bg-black dark:text-white' : 'bg-slate-200 dark:bg-zinc-800'}`}>
                                {useGoogleSearch && <Check size={10} strokeWidth={4} />}
                             </div>
                          </div>
                       </div>

                       <FileUpload 
                          label="风格参考图" 
                          preview={imgReference?.url}
                          onFileSelect={setImgReference}
                          onClear={() => setImgReference(null)}
                        />
                    </div>
                  )}

                  {/* --- VIDEO CONTROLS --- */}
                  {activeTab === 'video' && (
                    <div className="space-y-6">
                      <div className="flex p-1 bg-slate-100 dark:bg-zinc-900 rounded-lg border border-slate-200 dark:border-zinc-800">
                         {['text2vid', 'img2vid', 'first_last'].map(mode => (
                           <button
                             key={mode}
                             onClick={() => setVideoMode(mode)}
                             className={`flex-1 py-2 text-[10px] uppercase font-bold tracking-wider rounded-md transition-all ${videoMode === mode ? 'bg-white dark:bg-zinc-800 text-blue-600 dark:text-white shadow-sm ring-1 ring-black/5 dark:ring-white/10' : 'text-slate-400 dark:text-zinc-500 hover:text-slate-600 dark:hover:text-zinc-300'}`}
                           >
                             {mode === 'text2vid' && '文生视频'}
                             {mode === 'img2vid' && '图生视频'}
                             {mode === 'first_last' && '首尾帧'}
                           </button>
                         ))}
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <Select 
                           label="视频分辨率" 
                           value={vidRes} 
                           onChange={setVidRes} 
                           options={VID_RESOLUTIONS} 
                        />
                        <Select 
                           label="宽高比" 
                           value={vidRatio} 
                           onChange={setVidRatio} 
                           options={VID_ASPECT_RATIOS} 
                        />
                      </div>

                      {(videoMode === 'img2vid' || videoMode === 'extend') && (
                         <FileUpload 
                           label="参考图片" 
                           preview={vidFirstFrame?.url}
                           onFileSelect={setVidFirstFrame}
                           onClear={() => setVidFirstFrame(null)}
                         />
                      )}

                      {videoMode === 'first_last' && (
                        <div className="grid grid-cols-2 gap-4">
                           <FileUpload 
                             label="首帧图片" 
                             preview={vidFirstFrame?.url}
                             onFileSelect={setVidFirstFrame}
                             onClear={() => setVidFirstFrame(null)}
                           />
                           <FileUpload 
                             label="尾帧图片" 
                             preview={vidLastFrame?.url}
                             onFileSelect={setVidLastFrame}
                             onClear={() => setVidLastFrame(null)}
                           />
                        </div>
                      )}
                    </div>
                  )}

                  <div className="pt-4 border-t border-slate-200 dark:border-zinc-900">
                    <Button 
                      onClick={activeTab === 'image' ? handleGenerateImage : handleGenerateVideo}
                      disabled={activeTab === 'image' ? isGeneratingImg : isGeneratingVid}
                      className="w-full h-12 text-base shadow-lg shadow-blue-500/20 dark:shadow-none"
                    >
                      {activeTab === 'image' 
                        ? (isGeneratingImg ? "生成中..." : "生成图像") 
                        : (isGeneratingVid ? "渲染中..." : "生成视频")}
                    </Button>
                  </div>

                </div>
              </div>

              {/* RIGHT PANEL: DISPLAY */}
              <div className="flex-1 bg-white dark:bg-zinc-900/50 rounded-2xl border border-slate-200 dark:border-zinc-800 p-8 min-h-[600px] flex flex-col relative shadow-sm">
                 
                 {/* Empty State */}
                 {((activeTab === 'image' && generatedImages.length === 0 && !isGeneratingImg) || 
                   (activeTab === 'video' && !generatedVideo && !isGeneratingVid)) && (
                   <div className="absolute inset-0 flex flex-col items-center justify-center opacity-40 select-none pointer-events-none">
                      <div className="w-24 h-24 bg-slate-50 dark:bg-zinc-900 rounded-full flex items-center justify-center mb-6">
                        {activeTab === 'image' ? <ImageIcon size={32} className="text-slate-300 dark:text-zinc-700" /> : <Film size={32} className="text-slate-300 dark:text-zinc-700" />}
                      </div>
                      <p className="text-slate-300 dark:text-zinc-700 font-bold text-2xl tracking-tighter">等待输入</p>
                   </div>
                 )}

                 {/* --- IMAGE GALLERY --- */}
                 {activeTab === 'image' && (
                   <>
                     {isGeneratingImg && (
                       <div className="absolute inset-0 z-20 flex flex-col items-center justify-center bg-white/60 dark:bg-zinc-950/50 backdrop-blur-sm rounded-2xl">
                          <Loader2 className="animate-spin text-blue-600 dark:text-white mb-4" size={32} />
                          <span className="text-xs font-bold tracking-widest uppercase text-slate-500 dark:text-zinc-400">处理中</span>
                       </div>
                     )}

                     <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 z-10">
                       {generatedImages.map((img) => (
                         <ImageCard 
                           key={img.id} 
                           img={img} 
                           onMakeVideo={() => transferToVideo(img.url)} 
                         />
                       ))}
                     </div>
                   </>
                 )}

                 {/* --- VIDEO PLAYER --- */}
                 {activeTab === 'video' && (
                   <div className="flex-1 flex flex-col z-10 h-full justify-center">
                      
                      {isGeneratingVid && (
                        <div className="flex flex-col items-center justify-center gap-6">
                          <div className="w-64 h-1 bg-slate-200 dark:bg-zinc-800 overflow-hidden rounded-full">
                            <div className="h-full bg-blue-600 dark:bg-white w-1/3 animate-[shimmer_1.5s_infinite]"></div>
                          </div>
                          <p className="text-[10px] font-bold tracking-widest uppercase text-slate-400 dark:text-zinc-500">正在渲染帧缓冲区</p>
                        </div>
                      )}

                      {generatedVideo && !isGeneratingVid && (
                        <div className="w-full aspect-video bg-black rounded-xl overflow-hidden relative shadow-2xl ring-1 ring-slate-900/5 dark:ring-white/10 group">
                          <video 
                            src={generatedVideo.url} 
                            controls 
                            autoPlay 
                            loop 
                            className="w-full h-full object-contain"
                          ></video>
                          
                          <div className="absolute top-4 left-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col gap-1">
                             <span className="px-2 py-1 bg-white/10 backdrop-blur-md text-white text-[10px] font-mono border border-white/20 rounded-md inline-block self-start">
                               {generatedVideo.resolution}
                             </span>
                             <span className="px-2 py-1 bg-white/10 backdrop-blur-md text-white text-[10px] font-mono border border-white/20 rounded-md inline-block self-start">
                               {generatedVideo.ratio}
                             </span>
                          </div>
                        </div>
                      )}
                   </div>
                 )}

              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  );
}

// --- Sub-Components ---

const NavButton = ({ active, onClick, icon: Icon, label, expanded }) => (
  <button 
    onClick={onClick}
    className={`w-full flex items-center p-3 rounded-lg transition-all duration-200 group
      ${active 
        ? 'bg-blue-50 text-blue-600 dark:bg-zinc-900 dark:text-white' 
        : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-zinc-500 dark:hover:bg-zinc-900/50 dark:hover:text-zinc-300'}
    `}
  >
    <Icon size={18} className={`${active ? 'text-blue-600 dark:text-white' : 'text-slate-400 dark:text-zinc-600 group-hover:text-slate-600 dark:group-hover:text-zinc-400'} transition-colors`} />
    
    <span className={`ml-3 font-medium text-sm whitespace-nowrap overflow-hidden transition-all duration-300 ${expanded ? 'opacity-100 max-w-[150px]' : 'opacity-0 max-w-0'}`}>
      {label}
    </span>
  </button>
);

const ImageCard = ({ img, onMakeVideo }) => (
  <div className="group relative rounded-xl overflow-hidden bg-slate-100 dark:bg-zinc-950 border border-slate-200 dark:border-zinc-800 aspect-[4/3] hover:shadow-lg hover:shadow-blue-900/5 dark:hover:shadow-none transition-all duration-300">
    <img src={img.url} alt="Generated" className="w-full h-full object-cover transition-all duration-500" />
    
    <div className="absolute inset-0 bg-white/90 dark:bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex flex-col justify-center items-center gap-3 p-4 backdrop-blur-[2px]">
       <p className="text-xs text-center text-slate-600 dark:text-zinc-400 line-clamp-2 px-2 italic">
         "{img.prompt}"
       </p>
       <div className="flex gap-2 mt-2 scale-95 group-hover:scale-100 transition-transform duration-300 delay-75">
          <button 
            onClick={onMakeVideo}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 dark:bg-white text-white dark:text-black text-xs font-bold rounded-full hover:scale-105 transition-transform shadow-lg shadow-blue-600/20 dark:shadow-none"
          >
            <Film size={12} />
            生成视频
          </button>
          <button className="p-2 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-full hover:bg-slate-50 dark:hover:bg-zinc-800 transition-colors text-slate-700 dark:text-white">
            <Download size={14} />
          </button>
       </div>
    </div>
    
    <div className="absolute top-3 left-3 px-2 py-1 bg-white/90 dark:bg-black/90 text-slate-900 dark:text-white text-[9px] font-bold uppercase tracking-wider rounded-sm backdrop-blur-md opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-100">
       {img.ratio}
    </div>
  </div>
);