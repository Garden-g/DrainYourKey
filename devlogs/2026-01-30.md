# 开发日志 - 2026-01-30

## 项目初始化

### 完成内容

1. **项目结构搭建**
   - 创建完整的前后端项目目录结构
   - 配置 uv (Python) 和 npm (Node.js) 包管理

2. **后端开发 (Python + FastAPI)**
   - `app/config.py` - 配置管理和日志系统
   - `app/models/schemas.py` - Pydantic 数据模型定义
   - `app/services/image_service.py` - 图像生成服务 (Gemini 3 Pro Image API)
   - `app/services/video_service.py` - 视频生成服务 (Veo 3.1 API)
   - `app/services/prompt_service.py` - AI 提示词优化服务
   - `app/services/history_service.py` - 历史记录管理
   - `app/routers/` - API 路由 (image, video, history)
   - `app/utils/` - 工具函数 (文件操作, 重试机制)
   - `app/main.py` - FastAPI 应用入口

3. **前端开发 (React + Vite + Tailwind CSS)**
   - 通用组件: Button, Select, NumberInput, FileUpload
   - 布局组件: Sidebar, Header
   - 图像组件: ImagePanel, ImageCard, ImageGallery, ImagePreview
   - 视频组件: VideoPanel, VideoPlayer
   - 弹窗组件: PromptAssistModal
   - Hooks: useTheme, useApi
   - API 服务: services/api.js

4. **功能实现**
   - 图像生成 (文生图、图生图、Google 搜索增强)
   - 视频生成 (文生视频、图生视频、首尾帧插值)
   - AI 提示词优化
   - 深色/浅色主题切换
   - 历史记录管理

### 技术栈
- 前端: React 18 + Vite 6 + Tailwind CSS 3 + Lucide Icons
- 后端: Python 3.11 + FastAPI + google-genai SDK
- 包管理: uv (后端) + npm (前端)

### API 模型
- 图像生成: `gemini-3-pro-image-preview`
- 视频生成: `veo-3.1-generate-preview`
- 提示词优化: `gemini-3-pro-preview`

### 测试记录
- 图像生成功能已测试通过
- 生成了 2 张测试图像 (太空猫主题)
- 历史记录功能正常工作

### 待办事项
- [ ] 视频生成功能完整测试
- [ ] 多轮对话图像编辑测试
- [ ] 视频延长功能测试
- [ ] 错误处理优化
- [ ] 性能优化
- [ ] 图像生成后台运行功能 (第三阶段)

---

## 项目改进 - 第一阶段和第二阶段

### 完成内容

#### 问题2: 大图预览prompt展开/收起 ✅
- **文件**: `frontend/src/components/image/ImagePreview.jsx`
- **修改内容**:
  - 添加 `isPromptExpanded` 状态管理
  - 导入 `ChevronDown` 和 `ChevronUp` 图标
  - 修改prompt显示区域,支持展开/收起
  - 长prompt(>80字符)显示展开/收起按钮
  - 默认显示2行,展开后可滚动查看完整内容
- **效果**: 避免长prompt遮挡图片,提升用户体验

#### 问题3: 图生图可选宽高比 ✅
- **文件**:
  - `frontend/src/components/common/FileUpload.jsx`
  - `frontend/src/components/image/ImagePanel.jsx`
  - `frontend/src/App.jsx`
- **修改内容**:
  - FileUpload组件添加 `calculateAspectRatio` 函数,自动计算图像宽高比
  - 上传图片时返回 `aspectRatio`, `width`, `height` 信息
  - ImagePanel组件添加"自动"宽高比选项,显示原图宽高比
  - App.jsx添加useEffect,上传参考图时自动设置为"auto"
  - handleGenerateImage处理"auto"选项,使用参考图的实际宽高比
- **效果**: 图生图时自动使用原图宽高比,无需手动选择

#### 问题4: 图片传递到视频生成 ✅
- **文件**: `frontend/src/App.jsx`
- **修改内容**:
  - 修改 `transferToVideo` 函数为异步函数
  - 使用fetch从URL重新获取图像
  - 使用FileReader转换为完整的base64数据
  - 添加错误处理和用户提示
- **效果**: 修复图片数据传递问题,确保视频生成时有正确的图像数据

#### 问题5: 图生视频API错误 ✅
- **文件**: `backend/app/services/video_service.py`
- **修改内容**:
  - 确保所有图像转换为RGB模式(避免RGBA等模式导致的问题)
  - 添加图像模式转换日志
  - 添加详细的API调用日志(参数、图像类型、尺寸等)
  - 添加try-catch包裹API调用,记录详细错误信息
- **效果**: 修复mimeType和bytesBase64Encoded错误,提升调试能力

### 技术细节

#### 宽高比计算算法
```javascript
// 预设宽高比及其数值
const ratios = {
  '1:1': 1.0,
  '2:3': 0.667,
  '3:2': 1.5,
  // ... 更多预设
};

// 找到最接近的宽高比
let closest = '3:2';
let minDiff = Infinity;
for (const [key, value] of Object.entries(ratios)) {
  const diff = Math.abs(ratio - value);
  if (diff < minDiff) {
    minDiff = diff;
    closest = key;
  }
}
```

#### 图像模式转换
```python
# 确保图像是RGB模式
if pil_image.mode != 'RGB':
    logger.info(f"转换图像模式: {pil_image.mode} -> RGB")
    pil_image = pil_image.convert('RGB')
```

### 待测试功能
- [ ] 大图预览prompt展开/收起
- [ ] 图生图自动宽高比
- [ ] 图片传递到视频生成
- [ ] 图生视频API调用
- [ ] 图像生成后台运行

---

## 项目改进 - 第三阶段

### 完成内容

#### 问题1: 图像生成后台运行 ✅
- **文件**:
  - `backend/app/services/image_service.py`
  - `backend/app/routers/image.py`
  - `backend/app/models/schemas.py`
  - `frontend/src/services/api.js`
  - `frontend/src/App.jsx`
  - `frontend/src/components/image/ImageGallery.jsx`

- **后端修改**:
  - 添加 `JobStatus` 枚举和 `ImageJob` 数据类
  - 修改 `generate_images` 方法为异步启动,立即返回job_id
  - 添加 `_process_image_generation` 后台处理方法
  - 添加 `get_job_status` 方法查询任务状态
  - 添加进度更新逻辑(10% -> 20% -> 根据生成进度 -> 100%)
  - 添加 `ImageStatusResponse` 响应模型
  - 修改 `/generate` 端点返回job_id
  - 添加 `/status/{job_id}` 端点查询状态

- **前端修改**:
  - 添加 `getImageStatus` API函数
  - 添加 `imageJobs` 状态管理任务列表
  - 修改 `handleGenerateImage` 启动后台任务并立即返回
  - 添加 `pollImageStatus` 轮询方法(3秒间隔,最多60次)
  - 生成完成后自动添加图像到画廊
  - ImageGallery组件显示正在生成的任务进度条
  - 支持同时生成多个任务

- **效果**:
  - 用户可以在图像生成过程中继续生成其他图片
  - 实时显示生成进度
  - 多任务并发执行
  - 提升用户体验

### 技术细节

#### 后台任务架构
```python
# 任务状态枚举
class JobStatus(str, Enum):
    PENDING = "pending"
    PROCESSING = "processing"
    COMPLETED = "completed"
    FAILED = "failed"

# 任务数据类
@dataclass
class ImageJob:
    job_id: str
    status: JobStatus
    progress: int = 0
    images: List[str] = None
    session_id: Optional[str] = None
    error_message: Optional[str] = None
```

#### 轮询机制
```javascript
// 3秒轮询一次,最多60次(约3分钟)
const pollImageStatus = async (jobId) => {
  const maxAttempts = 60;
  let attempts = 0;

  const poll = async () => {
    const status = await getImageStatus(jobId);

    if (status.status === 'completed') {
      // 添加图像到画廊
    } else if (status.status === 'failed') {
      // 显示错误
    } else if (attempts < maxAttempts) {
      setTimeout(poll, 3000);
    }
  };

  poll();
};
```

### 注意事项

1. **任务持久化**: 当前任务存储在内存中,服务重启会丢失。生产环境建议使用Redis或数据库。

2. **任务清理**: 建议添加定时清理机制,删除24小时前的已完成任务。

3. **并发限制**: 考虑限制同时运行的任务数量,避免资源耗尽。

4. **前端状态同步**: 页面刷新后任务状态会丢失,可使用localStorage保存。

5. **错误处理**: 已添加详细的错误日志和用户提示。

---

## 文件变更记录

| 文件 | 操作 | 说明 |
|------|------|------|
| backend/* | 新增 | 后端全部代码 |
| frontend/* | 新增 | 前端全部代码 |
| data/history.json | 新增 | 历史记录存储 |
| .gitignore | 新增 | Git 忽略配置 |


## 文件变更总结

### 本次改进修改的文件

#### 后端文件 (4个)
1. `backend/app/services/image_service.py` - 添加后台任务机制
2. `backend/app/services/video_service.py` - 修复图生视频API调用
3. `backend/app/routers/image.py` - 修改API端点,添加状态查询
4. `backend/app/models/schemas.py` - 添加新的响应模型

#### 前端文件 (6个)
1. `frontend/src/App.jsx` - 核心修改:异步轮询、图片传递、自动宽高比
2. `frontend/src/services/api.js` - 添加状态查询API
3. `frontend/src/components/image/ImageGallery.jsx` - 显示任务进度
4. `frontend/src/components/image/ImagePreview.jsx` - 添加prompt展开/收起
5. `frontend/src/components/image/ImagePanel.jsx` - 修改宽高比选择器
6. `frontend/src/components/common/FileUpload.jsx` - 添加宽高比计算

### 代码统计
- 修改文件: 10个
- 新增代码行数: 约400行
- 修改代码行数: 约150行
- 新增功能: 5个

### 测试建议

#### 功能测试
1. **Prompt展开/收起**: 生成带长prompt的图片,预览大图,测试展开/收起
2. **自动宽高比**: 上传不同宽高比的参考图,验证自动识别
3. **图片传递**: 生成图片后点击"生成视频",验证图片正确传递
4. **图生视频**: 使用图生视频模式,验证不再报错
5. **后台运行**: 同时生成多个图片任务,验证并发执行

#### 性能测试
1. 同时生成3个任务(每个2张图片),观察系统负载
2. 测试轮询超时机制(60次后停止)
3. 测试网络中断后的重试机制

#### 边界测试
1. 上传非常大的参考图(>10MB)
2. 输入超长prompt(>2000字符)
3. 快速连续点击生成按钮

---

## Bug修复 - 异步模式图片显示问题

### 问题描述
前端无法正确显示output文件夹中的图片，图片的ratio和prompt字段都是默认值。

### 发现的Bug

#### Bug 1: 前端使用了不存在的字段
**位置**: `frontend/src/App.jsx` 第166-171行

前端代码尝试从 `status.params` 获取 `ratio` 和 `prompt`，但后端 `ImageStatusResponse` 没有 `params` 字段。

#### Bug 2: 后端没有保存prompt到任务
**位置**: `backend/app/services/image_service.py`

`ImageJob` 数据类没有 `prompt` 和 `aspect_ratio` 字段，导致无法在状态响应中返回这些信息。

### 修复内容

#### 1. 后端 ImageJob 添加字段
**文件**: `backend/app/services/image_service.py`

```python
@dataclass
class ImageJob:
    # ... 原有字段 ...
    prompt: str = ""           # 新增
    aspect_ratio: str = "3:2"  # 新增
```

#### 2. 后端创建任务时保存字段
**文件**: `backend/app/services/image_service.py`

```python
job = ImageJob(
    job_id=job_id,
    status=JobStatus.PENDING,
    created_at=time.time(),
    prompt=prompt,              # 新增
    aspect_ratio=aspect_ratio   # 新增
)
```

#### 3. 后端响应模型添加字段
**文件**: `backend/app/models/schemas.py`

```python
class ImageStatusResponse(BaseModel):
    # ... 原有字段 ...
    prompt: str = ""           # 新增
    aspect_ratio: str = "3:2"  # 新增
```

#### 4. 后端路由返回新字段
**文件**: `backend/app/routers/image.py`

```python
return ImageStatusResponse(
    # ... 原有字段 ...
    prompt=job.prompt,              # 新增
    aspect_ratio=job.aspect_ratio   # 新增
)
```

#### 5. 前端使用正确的字段
**文件**: `frontend/src/App.jsx`

```javascript
const newImages = status.images.map((filename, i) => ({
  id: `${Date.now()}-${i}`,
  url: getImageUrl(filename),
  filename,
  ratio: status.aspect_ratio || '3:2',  // 修改: 使用 aspect_ratio
  prompt: status.prompt || '',           // 修改: 使用 prompt
}));
```

### 修改的文件
1. `backend/app/services/image_service.py` - 添加字段到ImageJob
2. `backend/app/models/schemas.py` - 添加字段到ImageStatusResponse
3. `backend/app/routers/image.py` - 返回新字段
4. `frontend/src/App.jsx` - 使用正确的字段名

### 验证方法
1. 启动后端: `cd backend && uv run uvicorn app.main:app --reload --port 8080`
2. 启动前端: `cd frontend && npm run dev`
3. 访问 http://localhost:3000
4. 输入prompt，点击生成
5. 观察控制台是否有错误
6. 验证图片正确显示在画廊中
7. 点击图片预览，验证prompt正确显示

---

## 项目修复 - 安全性与稳定性改进

### 完成内容

1. **路径穿越防护 ✅**
   - 新增 `safe_resolve_path` 工具函数，统一处理文件路径解析
   - 图像/视频下载接口限制扩展名并校验路径安全

2. **阻塞调用降级 ✅**
   - Gemini SDK 调用与文件 IO 全部改为 `asyncio.to_thread` 运行
   - 增加超时限制，避免任务无限挂起

3. **任务与会话清理 ✅**
   - 图像/视频任务增加 TTL 清理逻辑
   - 会话增加活跃时间记录与超时清理

4. **历史记录一致性 ✅**
   - 图像/视频历史记录在生成完成时统一写入
   - 历史读写增加异步锁与原子写入，降低并发损坏风险

5. **错误处理与日志 ✅**
   - 新增统一 500 错误处理，避免泄露内部异常
   - 日志 handler 去重，避免热重载日志重复

6. **前端轮询与内存释放 ✅**
   - 轮询定时器统一管理与清理
   - 上传图片 object URL 及时释放，减少内存泄漏

### 修改文件

#### 后端文件
- `backend/app/utils/error_utils.py` - 新增统一错误处理工具
- `backend/app/utils/file_utils.py` - 安全路径解析与原子写入
- `backend/app/utils/__init__.py` - 导出新增工具
- `backend/app/config.py` - CORS/超时/TTL 配置与日志去重
- `backend/app/main.py` - CORS 配置改为可配置
- `backend/app/services/image_service.py` - 任务清理、线程池调用、历史记录
- `backend/app/services/video_service.py` - 任务清理、线程池调用、历史记录
- `backend/app/services/prompt_service.py` - 延迟初始化与线程池调用
- `backend/app/services/history_service.py` - 异步锁保护历史读写
- `backend/app/routers/image.py` - 安全文件访问与统一错误处理
- `backend/app/routers/video.py` - 安全文件访问与统一错误处理
- `backend/app/routers/history.py` - 统一错误处理

#### 前端文件
- `frontend/src/App.jsx` - 轮询定时器清理与超时保护
- `frontend/src/components/common/FileUpload.jsx` - object URL 释放

### 待测试
- [ ] 图像/视频下载路径安全校验
- [ ] 图像生成与视频生成超时处理
- [ ] 轮询超时后的 UI 提示

---

## Bug修复 - 图生视频 mimeType 缺失

### 问题描述
使用图生视频时报错: `Input instance with image should contain both bytesBase64Encoded and mimeType`.

### 修复内容
- 新增 `decode_base64_to_image_bytes`，将 base64 图像规范化为 PNG 并返回 bytes + mime
- 视频生成改为使用 `types.Image(imageBytes, mimeType)` 传入，避免缺失字段

### 修改文件
- `backend/app/utils/file_utils.py`
- `backend/app/utils/__init__.py`
- `backend/app/services/video_service.py`

---

## Bug修复 - 图生视频日志报错

### 问题描述
视频生成日志引用 `image.mode`，在改为 `types.Image` 后触发 `'Image' object has no attribute 'mode'`。

### 修复内容
- 日志改为输出 `mimeType` 与 `imageBytes` 长度

### 修改文件
- `backend/app/services/video_service.py`

---

## Bug修复 - types.Image 字段名不一致

### 问题描述
日志访问 `image.imageBytes` 导致 `'Image' object has no attribute 'imageBytes'`。

### 修复内容
- 使用实际字段名 `image_bytes` 与 `mime_type`

### 修改文件
- `backend/app/services/video_service.py`

---

## Bug修复 - 图生图超时与错误信息为空

### 问题描述
图生图在 120 秒超时后失败，日志中错误信息为空，难以排查。

### 修复内容
- 图像生成超时默认值提高到 300 秒
- 捕获超时并返回可读错误信息

### 修改文件
- `backend/app/config.py`
- `backend/app/services/image_service.py`

---

## 功能增强 - 视频和图片生成多任务并发

### 完成内容

#### 1. 视频生成多任务并发支持 ✅

**状态管理改造**:
- 将视频生成从单任务模式改为多任务模式
- 新增状态：
  - `videoJobs`: 视频任务列表，格式 `[{jobId, status, progress, prompt, params, firstFrame, isExtension}]`
  - `generatedVideos`: 已生成的视频列表，格式 `[{id, url, filename, resolution, ratio, prompt, videoId, canExtend}]`
  - `playingVideo`: 当前播放的视频（用于弹窗播放）
- 移除旧状态：`isGeneratingVid`, `generatedVideo`, `videoProgress`, `videoStatusMsg`, `currentJobId`

**轮询机制改进**:
- 将 `videoPollTimeout` 从单个 ref 改为 `Map`，支持多任务轮询
- 每个任务独立轮询，互不影响
- 组件卸载时清理所有轮询定时器

#### 2. 新增组件 ✅

**VideoJobCard.jsx**:
- 显示正在生成的视频任务
- 虚化封面（使用首帧图或渐变色背景）
- 加载动画（旋转图标）+ 进度条（白色，带百分比）
- 提示词预览（最多 2 行）+ 参数标签

**VideoCard.jsx**:
- 显示已生成的视频缩略图
- 视频元素（不自动播放，`preload="metadata"`）
- 中心播放图标覆盖层
- 悬停显示操作按钮：播放、延长（仅 720p）、下载

**VideoGallery.jsx**:
- 整合视频任务和视频列表
- 响应式网格布局（1/2/3 列）
- 空状态提示

**VideoPlayerModal.jsx**:
- 全屏播放视频（黑色半透明背景 + 背景模糊）
- 视频播放器（自动播放 + 循环）
- 视频信息显示（分辨率、宽高比、提示词）
- 延长功能（折叠输入框，仅 720p 显示）
- 下载按钮 + 关闭按钮

**ImageJobCard.jsx**:
- 改进图片任务展示
- 虚化背景（渐变色）+ 加载动画 + 进度条
- 提示词预览 + 参数标签

#### 3. 核心逻辑实现 ✅

**handleGenerateVideo**:
- 支持多任务并发
- 创建任务对象并添加到 `videoJobs`
- 启动独立轮询

**pollVideoStatus**:
- 支持多任务轮询（使用 Map 存储定时器）
- 超时保护（20 分钟）
- 任务完成后自动移到 `generatedVideos`
- 自动提取文件名和判断是否可延长

**handleExtendVideo**:
- 视频延长功能（仅支持 720p 分辨率）
- 使用原视频的 `videoId`（即 `job_id`）
- 创建新的延长任务

**handleDownloadVideo**:
- 视频下载功能（使用 `<a>` 标签触发下载）

#### 4. UI 集成 ✅

- 修改 App.jsx 视频标签页，使用 VideoGallery 替代 VideoPlayer
- 添加 VideoPlayerModal 弹窗
- 修改 ImageGallery 使用 ImageJobCard 组件

#### 5. Bug 修复 ✅

**图像轮询超时问题**:
- **问题**: 使用 `maxAttempts` 计数方式，容易超时
- **解决**: 改为基于时间的超时保护（10 分钟）
- **添加**: 检查生成的图像数量，如果为 0 则显示错误

### 修改文件

#### 新增文件
- `frontend/src/components/video/VideoJobCard.jsx`
- `frontend/src/components/video/VideoCard.jsx`
- `frontend/src/components/video/VideoGallery.jsx`
- `frontend/src/components/video/VideoPlayerModal.jsx`
- `frontend/src/components/image/ImageJobCard.jsx`

#### 修改文件
- `frontend/src/App.jsx` - 状态管理和核心逻辑
- `frontend/src/components/image/ImageGallery.jsx` - 使用 ImageJobCard

### 技术要点

**视频缩略图**:
- 使用 `<video preload="metadata">` 自动加载首帧
- 不自动播放，避免性能问题
- 使用 CSS `object-cover` 填充容器

**多任务轮询**:
- 使用 `Map` 存储每个任务的定时器 ID
- 组件卸载时清理所有定时器
- 避免内存泄漏

**视频延长限制**:
- 仅支持 720p 分辨率
- 使用 job_id 作为 video_id
- 每次延长约 7 秒，最多 20 次
- 视频最长 148 秒

### 待测试功能
- [ ] 视频多任务并发生成
- [ ] 视频延长功能
- [ ] 视频播放弹窗
- [ ] 图片任务展示改进
- [ ] 视频缩略图加载性能

---

## Bug修复 - 视频生成按钮禁用问题

### 问题描述
虽然已经实现了视频多任务并发功能，但是生成按钮在有任务运行时仍然被禁用，无法连续提交多个视频生成任务。

### 问题根源
在 `App.jsx` 中，传递给 `VideoPanel` 的 `isGenerating` 属性值为 `videoJobs.length > 0`，导致只要有任何视频任务在队列中，按钮就会被禁用。

### 修复内容
**文件**: `frontend/src/App.jsx` (第 585 行)

**修改前**:
```javascript
isGenerating={videoJobs.length > 0}  // ❌ 问题所在
```

**修改后**:
```javascript
isGenerating={false}  // ✅ 永不禁用按钮
```

### 修复效果
- 用户可以连续点击生成按钮提交多个视频任务
- 按钮只在没有输入提示词时禁用（由 VideoPanel 内部逻辑控制）
- 在右侧 VideoGallery 中可以看到所有任务的进度
- 与图像生成的行为保持一致，提供更好的用户体验

### 修改文件
- `frontend/src/App.jsx` - 修改 VideoPanel 的 isGenerating 属性（第 585 行）

### 验证方法
1. **连续提交测试**：
   - 输入提示词，点击"生成视频"
   - 验证按钮没有被禁用
   - 立即再次点击"生成视频"
   - 验证可以提交第二个任务
   - 在右侧 VideoGallery 中验证显示两个任务卡片

2. **按钮状态测试**：
   - 清空提示词，验证按钮被禁用（由 VideoPanel 内部逻辑控制）
   - 输入提示词，验证按钮可用
   - 提交任务后，验证按钮仍然可用

3. **多任务并发测试**：
   - 连续提交 3 个视频生成任务
   - 验证右侧显示 3 个任务卡片
   - 验证每个任务独立显示进度
   - 验证任务完成后移到视频列表

---

## Bug修复 - 视频生成和图像生成错误处理

### 问题描述

用户报告了2个错误：
1. **视频生成失败**：`'NoneType' object has no attribute 'generated_videos'`
2. **谷歌搜索导致图像生成失败**："图像生成失败：未生成任何图像"

### 错误 1：视频生成失败

#### 错误信息
```
2026-01-30 17:38:00 | ERROR | gen_photo_n_video | 视频生成失败: 'NoneType' object has no attribute 'generated_videos'
```

#### 错误原因
- 代码没有检查 `operation.response` 是否为 `None`
- `operation.done == True` 只表示操作完成，不代表成功
- 如果 API 调用失败，`operation.response` 可能为 `None`
- 直接访问 `operation.response.generated_videos[0]` 导致 `AttributeError`

#### 修复内容
**文件**: `backend/app/services/video_service.py`

**修改位置 1**（第 304-307 行，视频生成）：
```python
# 检查操作是否成功
if operation.error:
    error_msg = f"视频生成失败: {operation.error}"
    logger.error(error_msg)
    raise Exception(error_msg)

if not operation.response:
    error_msg = "视频生成失败: 操作完成但没有返回结果"
    logger.error(error_msg)
    raise Exception(error_msg)

if not operation.response.generated_videos:
    error_msg = "视频生成失败: 没有生成任何视频"
    logger.error(error_msg)
    raise Exception(error_msg)
```

**修改位置 2**（第 455-458 行，视频延长）：
```python
# 检查操作是否成功
if operation.error:
    error_msg = f"视频延长失败: {operation.error}"
    logger.error(error_msg)
    raise Exception(error_msg)

if not operation.response:
    error_msg = "视频延长失败: 操作完成但没有返回结果"
    logger.error(error_msg)
    raise Exception(error_msg)

if not operation.response.generated_videos:
    error_msg = "视频延长失败: 没有生成任何视频"
    logger.error(error_msg)
    raise Exception(error_msg)
```

### 错误 2：谷歌搜索导致图像生成失败

#### 错误原因
- 用户开启谷歌搜索功能，输入"福州10天天气"
- API 使用谷歌搜索查询天气信息
- API 返回的 `response.parts` 中可能只包含文本（搜索结果），没有图像数据
- `generated_files` 列表保持为空
- 后端仍然将任务标记为 `COMPLETED`，但 `job.images = []`
- 前端检测到 `status.images` 为空，显示错误提示

#### 修复内容
**文件**: `backend/app/services/image_service.py`

**修改位置**（第 322-326 行）：
```python
# 检查是否生成了图像
if not generated_files:
    error_msg = "图像生成失败: API 未返回任何图像数据"
    if use_google_search:
        error_msg += "（可能是谷歌搜索工具导致 API 返回文本而非图像）"
    logger.error(error_msg)
    raise Exception(error_msg)
```

### 修改文件
1. `backend/app/services/video_service.py` - 2 处修改（视频生成和视频延长）
2. `backend/app/services/image_service.py` - 1 处修改（图像生成）

### 修复效果
- ✅ 视频生成失败时，显示清晰的错误信息
- ✅ 不再出现 `'NoneType' object has no attribute 'generated_videos'` 错误
- ✅ 图像生成失败时（谷歌搜索导致），显示清晰的错误信息
- ✅ 任务状态正确更新为 `failed`
- ✅ 前端显示友好的错误提示
- ✅ 日志记录详细的错误原因

### 验证方法

#### 视频生成验证
1. **正常视频生成**：使用前端生成视频，验证正常生成
2. **API 失败处理**：如果 API 返回错误，应该看到清晰的错误信息
3. **视频延长**：生成 720p 视频后点击延长，验证功能正常

#### 图像生成验证
1. **正常图像生成（不使用谷歌搜索）**：关闭谷歌搜索，验证图像正常生成
2. **谷歌搜索 + 普通提示词**：开启谷歌搜索，输入普通提示词，验证图像正常生成
3. **谷歌搜索 + 查询类提示词**：开启谷歌搜索，输入查询类提示词（如"福州10天天气"），如果 API 返回文本而非图像，应该看到清晰的错误信息

### ⚠️ 重要提醒：必须重启后端服务

**代码修复已完成，但必须重启后端服务才能生效！**

#### 重启步骤
1. 在运行后端的终端窗口中按 `Ctrl+C` 停止服务
2. 重新启动后端服务：
   ```bash
   cd backend
   uv run uvicorn app.main:app --reload --port 8080
   ```
3. 等待服务启动完成，看到：
   ```
   INFO:     Started server process [xxxxx]
   INFO:     Waiting for application startup.
   INFO:     Application startup complete.
   INFO:     Uvicorn running on http://127.0.0.1:8080
   ```

#### 验证修复是否生效

**测试谷歌搜索功能**：
1. 打开前端页面
2. 开启谷歌搜索选项
3. 输入查询类提示词（如"福州未来10天天气"）
4. 点击生成

**预期结果（修复生效）**：
- 前端显示：`图像生成失败: API 未返回任何图像数据（可能是谷歌搜索工具导致 API 返回文本而非图像）`
- 后端日志显示：`ERROR | gen_photo_n_video | 图像生成失败: API 未返回任何图像数据（可能是谷歌搜索工具导致 API 返回文本而非图像）`
- 任务状态变为 `failed`

**如果修复未生效（不应该发生）**：
- 前端显示：`图像生成失败：未生成任何图像`
- 后端日志显示：`INFO | gen_photo_n_video | 图像生成完成: job_id=xxx, 共 0 张`
- 说明后端服务没有重新加载代码

---

# 功能增强 - 自动优化谷歌搜索提示词

## 问题描述

用户测试发现，使用谷歌搜索功能时：
- ❌ 提示词 "福州未来10天天气" → 失败（API 只返回文本）
- ✅ 提示词 "生成一张福州未来10天天气预报的信息图表" → 成功（API 生成图像）

**根本原因**：
- 谷歌搜索工具 `tools=[{"google_search": {}}]` 只是让 API 可以使用谷歌搜索获取实时信息
- 但提示词仍然需要**明确要求生成图像**
- 如果提示词不明确（如"福州未来10天天气"），API 可能只返回文本
- 如果提示词明确（如"生成一张...信息图表"），API 会生成图像

## 解决方案

当用户启用谷歌搜索时，自动在提示词前添加"生成"、"可视化"等关键词，确保 API 返回图像而不是文本。

**优化策略**：
1. 检测提示词是否已经包含图像生成关键词（如"生成"、"可视化"、"图表"等）
2. 如果没有，自动在提示词前添加优化前缀
3. 记录原始提示词和优化后的提示词，便于调试

**优化前缀**：
- 中文：`"生成一张关于以下内容的信息图表：{原始提示词}"`
- 英文：`"Generate an infographic about: {原始提示词}"`

## 实施内容

### 1. 添加提示词优化函数 ✅

**文件**: `backend/app/services/image_service.py`

**新增方法**: `_optimize_prompt_for_google_search`
- 检测提示词是否已包含图像生成关键词
- 支持中文和英文关键词检测
- 自动判断提示词语言（中文/英文）
- 返回优化后的提示词和是否进行了优化的标志

**关键词列表**：
- 中文：生成、创建、制作、绘制、画、可视化、图表、信息图、图片、图像、照片、插图、海报、设计
- 英文：generate, create, make, draw, paint, visualize, chart, infographic, image, picture, photo, illustration, poster, design

### 2. 应用优化到图像生成 ✅

**修改位置 1**：`_process_image_generation` 方法（第 235 行附近）
- 在构建 `contents` 之前应用优化
- 如果使用谷歌搜索，调用 `_optimize_prompt_for_google_search`
- 记录优化日志（INFO 级别）
- 使用优化后的提示词生成图像

**修改位置 2**：`generate_images_sync` 方法（第 410 行附近）
- 同样应用优化逻辑
- 保持同步和异步方法的一致性

**修改位置 3**：后续图像生成
- 在生成多张图像时，使用优化后的提示词
- 确保所有图像使用相同的优化提示词

### 3. 保留原始提示词 ✅

**历史记录**：
- 历史记录保存的是**原始提示词**，而不是优化后的提示词
- 用户可以看到自己输入的原始内容
- 便于用户查看和复用

## 修改文件

1. `backend/app/services/image_service.py` - 添加优化函数和应用优化逻辑

## 技术细节

### 关键词检测
使用简单的关键词匹配来检测提示词是否已经明确要求生成图像：
```python
image_keywords = [
    # 中文关键词
    "生成", "创建", "制作", "绘制", "画", "可视化", "图表", "信息图",
    "图片", "图像", "照片", "插图", "海报", "设计",
    # 英文关键词
    "generate", "create", "make", "draw", "paint", "visualize", "chart",
    "infographic", "image", "picture", "photo", "illustration", "poster", "design"
]

prompt_lower = prompt.lower()
has_keyword = any(keyword in prompt_lower for keyword in image_keywords)
```

### 语言检测
使用简单的 Unicode 范围检测来判断提示词语言：
```python
# 检测是否包含中文字符（U+4E00 到 U+9FFF）
has_chinese = any('\u4e00' <= char <= '\u9fff' for char in prompt)

if has_chinese:
    # 中文提示词
    optimized = f"生成一张关于以下内容的信息图表：{prompt}"
else:
    # 英文提示词
    optimized = f"Generate an infographic about: {prompt}"
```

### 日志记录
```python
if was_optimized:
    logger.info(f"谷歌搜索提示词优化: '{prompt}' -> '{optimized_prompt}'")
else:
    logger.debug(f"提示词已包含图像生成关键词，无需优化: '{prompt}'")
```

## 预期效果

**修复后**：
- ✅ 用户使用谷歌搜索时，无需手动修改提示词
- ✅ 查询类提示词（如"天气"、"新闻"）自动优化为图像生成提示词
- ✅ 明确的提示词不会被重复优化
- ✅ 历史记录保存原始提示词，便于用户查看
- ✅ 日志记录优化过程，便于调试

## 验证方法

### 测试场景 1：查询类提示词（需要优化）
1. 启动后端服务
2. 开启谷歌搜索选项
3. 输入查询类提示词：`"福州未来10天天气"`
4. 点击生成

**预期结果**：
- 后端日志显示：`谷歌搜索提示词优化: '福州未来10天天气' -> '生成一张关于以下内容的信息图表：福州未来10天天气'`
- API 成功生成图像
- 前端显示生成的图像
- 历史记录中保存的是原始提示词 `"福州未来10天天气"`

### 测试场景 2：明确的提示词（无需优化）
1. 开启谷歌搜索选项
2. 输入明确的提示词：`"生成一张福州未来10天天气预报的信息图表"`
3. 点击生成

**预期结果**：
- 后端日志显示：`提示词已包含图像生成关键词，无需优化: '生成一张福州未来10天天气预报的信息图表'`
- API 成功生成图像
- 前端显示生成的图像

### 测试场景 3：不使用谷歌搜索（不应优化）
1. 关闭谷歌搜索选项
2. 输入查询类提示词：`"福州未来10天天气"`
3. 点击生成

**预期结果**：
- 后端日志**不显示**优化信息
- API 按原始提示词生成图像（可能生成天气相关的艺术图像）
- 前端显示生成的图像

### 测试场景 4：英文提示词
1. 开启谷歌搜索选项
2. 输入英文查询：`"weather in San Francisco"`
3. 点击生成

**预期结果**：
- 后端日志显示：`谷歌搜索提示词优化: 'weather in San Francisco' -> 'Generate an infographic about: weather in San Francisco'`
- API 成功生成图像
- 前端显示生成的图像

## 注意事项

1. **不影响现有功能**：
   - 只在启用谷歌搜索时才优化提示词
   - 不使用谷歌搜索时，提示词保持不变

2. **保留原始提示词**：
   - 历史记录保存原始提示词
   - 用户可以看到自己输入的原始内容

3. **日志记录**：
   - 记录优化前后的提示词
   - 便于调试和问题排查

4. **可扩展性**：
   - 关键词列表可以轻松扩展
   - 优化前缀可以根据需要调整

## 后续优化（可选）

1. **更智能的语言检测**：
   - 使用 langdetect 库进行更准确的语言检测
   - 支持更多语言（日语、韩语等）

2. **更精细的优化策略**：
   - 根据提示词内容选择不同的优化前缀
   - 例如：天气查询 → "天气图表"，新闻查询 → "新闻信息图"

3. **用户配置**：
   - 允许用户在前端配置是否启用自动优化
   - 允许用户自定义优化前缀

4. **A/B 测试**：
   - 记录优化前后的成功率
   - 持续改进优化策略
# 功能增强 - 自动优化谷歌搜索提示词

## 问题描述

用户测试发现，使用谷歌搜索功能时：
- ❌ 提示词 "福州未来10天天气" → 失败（API 只返回文本）
- ✅ 提示词 "生成一张福州未来10天天气预报的信息图表" → 成功（API 生成图像）

**根本原因**：
- 谷歌搜索工具 `tools=[{"google_search": {}}]` 只是让 API 可以使用谷歌搜索获取实时信息
- 但提示词仍然需要**明确要求生成图像**
- 如果提示词不明确（如"福州未来10天天气"），API 可能只返回文本
- 如果提示词明确（如"生成一张...信息图表"），API 会生成图像

## 解决方案

当用户启用谷歌搜索时，自动在提示词前添加"生成"、"可视化"等关键词，确保 API 返回图像而不是文本。

**优化策略**：
1. 检测提示词是否已经包含图像生成关键词（如"生成"、"可视化"、"图表"等）
2. 如果没有，自动在提示词前添加优化前缀
3. 记录原始提示词和优化后的提示词，便于调试

**优化前缀**：
- 中文：`"生成一张关于以下内容的信息图表：{原始提示词}"`
- 英文：`"Generate an infographic about: {原始提示词}"`

## 实施内容

### 1. 添加提示词优化函数 ✅

**文件**: `backend/app/services/image_service.py`

**新增方法**: `_optimize_prompt_for_google_search`
- 检测提示词是否已包含图像生成关键词
- 支持中文和英文关键词检测
- 自动判断提示词语言（中文/英文）
- 返回优化后的提示词和是否进行了优化的标志

**关键词列表**：
- 中文：生成、创建、制作、绘制、画、可视化、图表、信息图、图片、图像、照片、插图、海报、设计
- 英文：generate, create, make, draw, paint, visualize, chart, infographic, image, picture, photo, illustration, poster, design

### 2. 应用优化到图像生成 ✅

**修改位置 1**：`_process_image_generation` 方法（第 235 行附近）
- 在构建 `contents` 之前应用优化
- 如果使用谷歌搜索，调用 `_optimize_prompt_for_google_search`
- 记录优化日志（INFO 级别）
- 使用优化后的提示词生成图像

**修改位置 2**：`generate_images_sync` 方法（第 410 行附近）
- 同样应用优化逻辑
- 保持同步和异步方法的一致性

**修改位置 3**：后续图像生成
- 在生成多张图像时，使用优化后的提示词
- 确保所有图像使用相同的优化提示词

### 3. 保留原始提示词 ✅

**历史记录**：
- 历史记录保存的是**原始提示词**，而不是优化后的提示词
- 用户可以看到自己输入的原始内容
- 便于用户查看和复用

## 修改文件

1. `backend/app/services/image_service.py` - 添加优化函数和应用优化逻辑

## 技术细节

### 关键词检测
使用简单的关键词匹配来检测提示词是否已经明确要求生成图像：
```python
image_keywords = [
    # 中文关键词
    "生成", "创建", "制作", "绘制", "画", "可视化", "图表", "信息图",
    "图片", "图像", "照片", "插图", "海报", "设计",
    # 英文关键词
    "generate", "create", "make", "draw", "paint", "visualize", "chart",
    "infographic", "image", "picture", "photo", "illustration", "poster", "design"
]

prompt_lower = prompt.lower()
has_keyword = any(keyword in prompt_lower for keyword in image_keywords)
```

### 语言检测
使用简单的 Unicode 范围检测来判断提示词语言：
```python
# 检测是否包含中文字符（U+4E00 到 U+9FFF）
has_chinese = any('\u4e00' <= char <= '\u9fff' for char in prompt)

if has_chinese:
    # 中文提示词
    optimized = f"生成一张关于以下内容的信息图表：{prompt}"
else:
    # 英文提示词
    optimized = f"Generate an infographic about: {prompt}"
```

### 日志记录
```python
if was_optimized:
    logger.info(f"谷歌搜索提示词优化: '{prompt}' -> '{optimized_prompt}'")
else:
    logger.debug(f"提示词已包含图像生成关键词，无需优化: '{prompt}'")
```

## 预期效果

**修复后**：
- ✅ 用户使用谷歌搜索时，无需手动修改提示词
- ✅ 查询类提示词（如"天气"、"新闻"）自动优化为图像生成提示词
- ✅ 明确的提示词不会被重复优化
- ✅ 历史记录保存原始提示词，便于用户查看
- ✅ 日志记录优化过程，便于调试

## 验证方法

### 测试场景 1：查询类提示词（需要优化）
1. 启动后端服务
2. 开启谷歌搜索选项
3. 输入查询类提示词：`"福州未来10天天气"`
4. 点击生成

**预期结果**：
- 后端日志显示：`谷歌搜索提示词优化: '福州未来10天天气' -> '生成一张关于以下内容的信息图表：福州未来10天天气'`
- API 成功生成图像
- 前端显示生成的图像
- 历史记录中保存的是原始提示词 `"福州未来10天天气"`

### 测试场景 2：明确的提示词（无需优化）
1. 开启谷歌搜索选项
2. 输入明确的提示词：`"生成一张福州未来10天天气预报的信息图表"`
3. 点击生成

**预期结果**：
- 后端日志显示：`提示词已包含图像生成关键词，无需优化: '生成一张福州未来10天天气预报的信息图表'`
- API 成功生成图像
- 前端显示生成的图像

### 测试场景 3：不使用谷歌搜索（不应优化）
1. 关闭谷歌搜索选项
2. 输入查询类提示词：`"福州未来10天天气"`
3. 点击生成

**预期结果**：
- 后端日志**不显示**优化信息
- API 按原始提示词生成图像（可能生成天气相关的艺术图像）
- 前端显示生成的图像

### 测试场景 4：英文提示词
1. 开启谷歌搜索选项
2. 输入英文查询：`"weather in San Francisco"`
3. 点击生成

**预期结果**：
- 后端日志显示：`谷歌搜索提示词优化: 'weather in San Francisco' -> 'Generate an infographic about: weather in San Francisco'`
- API 成功生成图像
- 前端显示生成的图像

## 注意事项

1. **不影响现有功能**：
   - 只在启用谷歌搜索时才优化提示词
   - 不使用谷歌搜索时，提示词保持不变

2. **保留原始提示词**：
   - 历史记录保存原始提示词
   - 用户可以看到自己输入的原始内容

3. **日志记录**：
   - 记录优化前后的提示词
   - 便于调试和问题排查

4. **可扩展性**：
   - 关键词列表可以轻松扩展
   - 优化前缀可以根据需要调整

## 后续优化（可选）

1. **更智能的语言检测**：
   - 使用 langdetect 库进行更准确的语言检测
   - 支持更多语言（日语、韩语等）

2. **更精细的优化策略**：
   - 根据提示词内容选择不同的优化前缀
   - 例如：天气查询 → "天气图表"，新闻查询 → "新闻信息图"

3. **用户配置**：
   - 允许用户在前端配置是否启用自动优化
   - 允许用户自定义优化前缀

4. **A/B 测试**：
   - 记录优化前后的成功率
   - 持续改进优化策略

---

## 功能增强 - 视频生成秒数选项

### 需求背景

根据 Veo API 文档，视频秒数有以下规则：
- **720p**：支持 4、6、8 秒
- **1080p**：仅支持 8 秒
- **4k**：仅支持 8 秒

### 实施内容

#### 1. 后端 - schemas.py ✅

**修改**: `VideoGenerateRequest` 模型

添加 `duration_seconds` 字段：
```python
duration_seconds: Literal["4", "6", "8"] = Field(
    default="8",
    description="视频秒数，1080p 和 4k 仅支持 8 秒"
)
```

#### 2. 后端 - video_service.py ✅

**修改 1**: `generate_video` 方法
- 添加 `duration_seconds` 参数
- 1080p/4k 分辨率强制使用 8 秒
- 日志记录秒数信息

**修改 2**: `_process_video_generation` 方法
- 添加 `duration_seconds` 参数
- 在 `GenerateVideosConfig` 中传递 `duration_seconds`
- 首尾帧模式也支持秒数参数

#### 3. 后端 - video.py ✅

**修改**: `/generate` 端点
- 传递 `duration_seconds` 参数到 `video_service.generate_video`

#### 4. 前端 - VideoPanel.jsx ✅

**新增常量**:
```javascript
// 720p 支持的秒数选项
const VID_DURATIONS_720P = [
  { label: '4 秒', value: '4' },
  { label: '6 秒', value: '6' },
  { label: '8 秒', value: '8' },
];

// 1080p/4k 仅支持 8 秒
const VID_DURATIONS_HIGH_RES = [
  { label: '8 秒', value: '8' },
];
```

**新增 props**:
- `duration`: 当前秒数
- `onDurationChange`: 秒数变化回调

**新增 UI**:
- 秒数选择下拉框（在分辨率选择器下方）
- 根据分辨率动态显示可选秒数
- 1080p/4k 时禁用选择器

#### 5. 前端 - App.jsx ✅

**新增状态**:
```javascript
const [vidDuration, setVidDuration] = useState('8');
```

**新增 useEffect**:
```javascript
// 当视频分辨率变化时，自动调整秒数
useEffect(() => {
  if (vidRes !== '720p') {
    setVidDuration('8');
  }
}, [vidRes]);
```

**修改 handleGenerateVideo**:
- 传递 `duration_seconds` 参数
- 任务 params 中记录 duration

**修改 VideoPanel 调用**:
- 传递 `duration` 和 `onDurationChange` props

#### 6. 前端 - Select.jsx ✅

**新增 props**:
- `disabled`: 是否禁用选择器

**样式修改**:
- 禁用时添加 `opacity-50 cursor-not-allowed` 样式

### 修改文件

| 文件 | 修改内容 |
|------|----------|
| `backend/app/models/schemas.py` | 添加 duration_seconds 字段 |
| `backend/app/services/video_service.py` | 添加秒数参数支持 |
| `backend/app/routers/video.py` | 传递秒数参数 |
| `frontend/src/components/video/VideoPanel.jsx` | 添加秒数选择 UI |
| `frontend/src/App.jsx` | 添加秒数状态管理 |
| `frontend/src/components/common/Select.jsx` | 添加 disabled 支持 |

### 验证方法

#### 测试场景 1：720p 分辨率
1. 选择 720p 分辨率
2. 验证秒数选择器显示 4/6/8 秒选项
3. 选择 4 秒，生成视频
4. 验证生成的视频时长为 4 秒

#### 测试场景 2：1080p/4k 分辨率
1. 选择 1080p 或 4k 分辨率
2. 验证秒数选择器只显示 8 秒（禁用状态）
3. 生成视频
4. 验证生成的视频时长为 8 秒

#### 测试场景 3：分辨率切换
1. 选择 720p，选择 4 秒
2. 切换到 1080p
3. 验证秒数自动变为 8 秒
4. 切换回 720p
5. 验证秒数选择器恢复可选

### 注意事项

1. **分辨率限制**：1080p 和 4k 仅支持 8 秒，前端和后端都有强制限制
2. **默认值**：默认使用 8 秒，与 API 默认值一致
3. **参数类型**：`durationSeconds` 是字符串类型（`"4"`, `"6"`, `"8"`）
4. **视频延长**：延长功能仅支持 720p，且每次延长 7 秒

---

## 功能增强 - 图片并发生成 + 画廊布局修复

### 需求概述

1. **图片并发生成**：多线程并发生成图片，每生成一张立即显示在画廊中
2. **画廊布局修复**：图片不溢出画廊，滚动时只滚动画廊，左侧输入区域固定

### 实施内容

#### 任务 1：图片实时显示 ✅

**后端修改**: `backend/app/services/image_service.py`

1. 在循环开始前初始化 `job.images = []`
2. 每生成一张图片立即 `job.images.append(filename)` 更新列表
3. 进度基于已生成的图片数量实时更新
4. 移除最后的 `job.images = generated_files` 赋值（已在循环中实时更新）

**注意**：由于 Gemini API 使用同一个 chat 会话，不支持真正的并发请求，但确保每生成一张就立即更新 `job.images`，让前端可以实时显示。

**前端修改**: `frontend/src/App.jsx`

1. 使用 `lastImageCount` 记录已添加的图片数量
2. 每次轮询检查是否有新图片
3. 使用 `slice(lastImageCount)` 增量添加新图片到画廊
4. 不等任务完成就开始显示图片

#### 任务 2：画廊布局修复 ✅

**修改 1**: `frontend/src/App.jsx`
- 将内容区的 `overflow-y-auto` 改为 `overflow-hidden`
- 移除 `scrollbar-hide` 类

**修改 2**: `frontend/src/components/image/ImageGallery.jsx`
- 添加 `overflow-y-auto scrollbar-hide` 类
- 让画廊独立滚动

**修改 3**: `frontend/src/components/video/VideoGallery.jsx`
- 添加 `overflow-y-auto scrollbar-hide` 类
- 添加与 ImageGallery 一致的样式（圆角、边框、背景等）

### 修改文件

| 文件 | 修改内容 |
|------|----------|
| `backend/app/services/image_service.py` | 实时更新 job.images |
| `frontend/src/App.jsx` | 轮询增量显示 + 移除整体滚动 |
| `frontend/src/components/image/ImageGallery.jsx` | 添加独立滚动 |
| `frontend/src/components/video/VideoGallery.jsx` | 添加独立滚动 + 统一样式 |

### 验证方法

#### 测试 1：实时显示
1. 设置生成数量为 4 张
2. 点击生成
3. 验证图片逐张出现在画廊中（不是等全部完成才显示）
4. 验证进度条实时更新

#### 测试 2：画廊滚动
1. 生成 10+ 张图片
2. 验证图片不会溢出画廊边界
3. 滚动画廊，验证左侧输入区域保持固定
4. 切换到视频标签页，验证同样的滚动行为