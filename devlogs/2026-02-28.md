# 开发日志 - 2026-02-28

## 任务

- 图片生成新增模型切换：`Nano Banana Pro` / `Nano Banana 2`
- 当用户选择 `Nano Banana 2` 时，支持新增分辨率与新增宽高比
- 参数合法性前后端双重校验，避免非法组合提交

## 关键改动

### 后端

- 更新 `backend/app/models/schemas.py`
  - `ImageGenerateRequest` 新增 `image_model` 字段，默认 `nano_banana_pro`
  - `resolution` 扩展为 `0.5K/1K/2K/4K`
  - `ImageStatusResponse` 新增 `image_model` 返回字段
- 更新 `backend/app/routers/image.py`
  - 生成接口将 `image_model` 透传至 service
  - 状态接口返回 `image_model`
- 更新 `backend/app/services/image_service.py`
  - 新增图片模型能力表（模型名、分辨率、宽高比）
  - 新增 `_resolve_image_generation_settings`，做模型能力校验与分辨率映射
  - `0.5K` 在后端映射为 Gemini `image_size=512px`
  - 调用 Gemini 时按 `image_model` 选择真实 provider model：
    - `nano_banana_pro` -> `gemini-3-pro-image-preview`
    - `nano_banana_2` -> `gemini-3.1-flash-image-preview`
  - 历史记录参数新增 `image_model`、`provider_model`、`provider_image_size`

### 前端

- 更新 `frontend/src/components/image/ImagePanel.jsx`
  - 新增“图片模型”下拉（Nano Banana Pro / Nano Banana 2）
  - 分辨率与宽高比按所选模型动态显示
- 更新 `frontend/src/App.jsx`
  - 新增 `imgModel` 状态（默认 `nano_banana_pro`）
  - 模型切换时自动回退不兼容分辨率/宽高比并提示
  - 生成请求新增 `image_model` 参数
  - 生成前增加兜底校验，避免 `auto` 比例导致非法组合
  - 图像任务卡参数补充模型信息
  - 宽高比识别算法新增 `1:4/4:1/1:8/8:1`
- 更新 `frontend/src/components/image/ReferenceImagesUpload.jsx`
  - 自动宽高比识别新增 `1:4/4:1/1:8/8:1`
- 更新 `frontend/src/components/image/ImageJobCard.jsx`
  - 任务卡新增模型标签展示
- 更新 `frontend/src/services/api.js`
  - 图像生成参数注释补充 `image_model` 与 `0.5K -> 512px` 说明

### 文档

- 更新 `README.md`：补充模型切换、分辨率与宽高比能力说明
- 更新 `CONTEXT.md`：补充模型能力映射、关键状态与改动入口

## 验证

- 已完成静态链路检查：`ImagePanel/App -> api.js -> schemas/router/service -> history params`
- 计划执行本地构建/编译检查，确认无语法错误

## 风险与注意事项

- `0.5K` 仅允许 `nano_banana_2` 使用，后端若收到非法组合会返回 400
- `auto` 宽高比在极端参考图下可能生成 Nano Banana 2 专属比例，前端已在提交前兜底回退
