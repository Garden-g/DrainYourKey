# 开发日志 - 2026-01-30

## 项目初始化

### 完成内容

1. **项目结构搭建**
   - 创建完整的前后端项目目录结构
   - 配置 uv (Python) 和 npm (Node.js) 包管理

2. **后端开发 (Python + FastAPI)**
   - `app/config.py` - 配置管理和日志系统
   - `app/models/schemas.py` - Pydantic 数据模型定义
   - `app/services/image_service.py` - 图像生成服务 (Gemini 3 Pro Image API)
   - `app/services/video_service.py` - 视频生成服务 (Veo 3.1 API)
   - `app/services/prompt_service.py` - AI 提示词优化服务
   - `app/services/history_service.py` - 历史记录管理
   - `app/routers/` - API 路由 (image, video, history)
   - `app/utils/` - 工具函数 (文件操作, 重试机制)
   - `app/main.py` - FastAPI 应用入口

3. **前端开发 (React + Vite + Tailwind CSS)**
   - 通用组件: Button, Select, NumberInput, FileUpload
   - 布局组件: Sidebar, Header
   - 图像组件: ImagePanel, ImageCard, ImageGallery, ImagePreview
   - 视频组件: VideoPanel, VideoPlayer
   - 弹窗组件: PromptAssistModal
   - Hooks: useTheme, useApi
   - API 服务: services/api.js

4. **功能实现**
   - 图像生成 (文生图、图生图、Google 搜索增强)
   - 视频生成 (文生视频、图生视频、首尾帧插值)
   - AI 提示词优化
   - 深色/浅色主题切换
   - 历史记录管理

### 技术栈
- 前端: React 18 + Vite 6 + Tailwind CSS 3 + Lucide Icons
- 后端: Python 3.11 + FastAPI + google-genai SDK
- 包管理: uv (后端) + npm (前端)

### API 模型
- 图像生成: `gemini-3-pro-image-preview`
- 视频生成: `veo-3.1-generate-preview`
- 提示词优化: `gemini-3-pro-preview`

### 测试记录
- 图像生成功能已测试通过
- 生成了 2 张测试图像 (太空猫主题)
- 历史记录功能正常工作

### 待办事项
- [ ] 视频生成功能完整测试
- [ ] 多轮对话图像编辑测试
- [ ] 视频延长功能测试
- [ ] 错误处理优化
- [ ] 性能优化
- [ ] 图像生成后台运行功能 (第三阶段)

---

## 项目改进 - 第一阶段和第二阶段

### 完成内容

#### 问题2: 大图预览prompt展开/收起 ✅
- **文件**: `frontend/src/components/image/ImagePreview.jsx`
- **修改内容**:
  - 添加 `isPromptExpanded` 状态管理
  - 导入 `ChevronDown` 和 `ChevronUp` 图标
  - 修改prompt显示区域,支持展开/收起
  - 长prompt(>80字符)显示展开/收起按钮
  - 默认显示2行,展开后可滚动查看完整内容
- **效果**: 避免长prompt遮挡图片,提升用户体验

#### 问题3: 图生图可选宽高比 ✅
- **文件**:
  - `frontend/src/components/common/FileUpload.jsx`
  - `frontend/src/components/image/ImagePanel.jsx`
  - `frontend/src/App.jsx`
- **修改内容**:
  - FileUpload组件添加 `calculateAspectRatio` 函数,自动计算图像宽高比
  - 上传图片时返回 `aspectRatio`, `width`, `height` 信息
  - ImagePanel组件添加"自动"宽高比选项,显示原图宽高比
  - App.jsx添加useEffect,上传参考图时自动设置为"auto"
  - handleGenerateImage处理"auto"选项,使用参考图的实际宽高比
- **效果**: 图生图时自动使用原图宽高比,无需手动选择

#### 问题4: 图片传递到视频生成 ✅
- **文件**: `frontend/src/App.jsx`
- **修改内容**:
  - 修改 `transferToVideo` 函数为异步函数
  - 使用fetch从URL重新获取图像
  - 使用FileReader转换为完整的base64数据
  - 添加错误处理和用户提示
- **效果**: 修复图片数据传递问题,确保视频生成时有正确的图像数据

#### 问题5: 图生视频API错误 ✅
- **文件**: `backend/app/services/video_service.py`
- **修改内容**:
  - 确保所有图像转换为RGB模式(避免RGBA等模式导致的问题)
  - 添加图像模式转换日志
  - 添加详细的API调用日志(参数、图像类型、尺寸等)
  - 添加try-catch包裹API调用,记录详细错误信息
- **效果**: 修复mimeType和bytesBase64Encoded错误,提升调试能力

### 技术细节

#### 宽高比计算算法
```javascript
// 预设宽高比及其数值
const ratios = {
  '1:1': 1.0,
  '2:3': 0.667,
  '3:2': 1.5,
  // ... 更多预设
};

// 找到最接近的宽高比
let closest = '3:2';
let minDiff = Infinity;
for (const [key, value] of Object.entries(ratios)) {
  const diff = Math.abs(ratio - value);
  if (diff < minDiff) {
    minDiff = diff;
    closest = key;
  }
}
```

#### 图像模式转换
```python
# 确保图像是RGB模式
if pil_image.mode != 'RGB':
    logger.info(f"转换图像模式: {pil_image.mode} -> RGB")
    pil_image = pil_image.convert('RGB')
```

### 待测试功能
- [ ] 大图预览prompt展开/收起
- [ ] 图生图自动宽高比
- [ ] 图片传递到视频生成
- [ ] 图生视频API调用
- [ ] 图像生成后台运行

---

## 项目改进 - 第三阶段

### 完成内容

#### 问题1: 图像生成后台运行 ✅
- **文件**:
  - `backend/app/services/image_service.py`
  - `backend/app/routers/image.py`
  - `backend/app/models/schemas.py`
  - `frontend/src/services/api.js`
  - `frontend/src/App.jsx`
  - `frontend/src/components/image/ImageGallery.jsx`

- **后端修改**:
  - 添加 `JobStatus` 枚举和 `ImageJob` 数据类
  - 修改 `generate_images` 方法为异步启动,立即返回job_id
  - 添加 `_process_image_generation` 后台处理方法
  - 添加 `get_job_status` 方法查询任务状态
  - 添加进度更新逻辑(10% -> 20% -> 根据生成进度 -> 100%)
  - 添加 `ImageStatusResponse` 响应模型
  - 修改 `/generate` 端点返回job_id
  - 添加 `/status/{job_id}` 端点查询状态

- **前端修改**:
  - 添加 `getImageStatus` API函数
  - 添加 `imageJobs` 状态管理任务列表
  - 修改 `handleGenerateImage` 启动后台任务并立即返回
  - 添加 `pollImageStatus` 轮询方法(3秒间隔,最多60次)
  - 生成完成后自动添加图像到画廊
  - ImageGallery组件显示正在生成的任务进度条
  - 支持同时生成多个任务

- **效果**:
  - 用户可以在图像生成过程中继续生成其他图片
  - 实时显示生成进度
  - 多任务并发执行
  - 提升用户体验

### 技术细节

#### 后台任务架构
```python
# 任务状态枚举
class JobStatus(str, Enum):
    PENDING = "pending"
    PROCESSING = "processing"
    COMPLETED = "completed"
    FAILED = "failed"

# 任务数据类
@dataclass
class ImageJob:
    job_id: str
    status: JobStatus
    progress: int = 0
    images: List[str] = None
    session_id: Optional[str] = None
    error_message: Optional[str] = None
```

#### 轮询机制
```javascript
// 3秒轮询一次,最多60次(约3分钟)
const pollImageStatus = async (jobId) => {
  const maxAttempts = 60;
  let attempts = 0;

  const poll = async () => {
    const status = await getImageStatus(jobId);

    if (status.status === 'completed') {
      // 添加图像到画廊
    } else if (status.status === 'failed') {
      // 显示错误
    } else if (attempts < maxAttempts) {
      setTimeout(poll, 3000);
    }
  };

  poll();
};
```

### 注意事项

1. **任务持久化**: 当前任务存储在内存中,服务重启会丢失。生产环境建议使用Redis或数据库。

2. **任务清理**: 建议添加定时清理机制,删除24小时前的已完成任务。

3. **并发限制**: 考虑限制同时运行的任务数量,避免资源耗尽。

4. **前端状态同步**: 页面刷新后任务状态会丢失,可使用localStorage保存。

5. **错误处理**: 已添加详细的错误日志和用户提示。

---

## 文件变更记录

| 文件 | 操作 | 说明 |
|------|------|------|
| backend/* | 新增 | 后端全部代码 |
| frontend/* | 新增 | 前端全部代码 |
| data/history.json | 新增 | 历史记录存储 |
| .gitignore | 新增 | Git 忽略配置 |


## 文件变更总结

### 本次改进修改的文件

#### 后端文件 (4个)
1. `backend/app/services/image_service.py` - 添加后台任务机制
2. `backend/app/services/video_service.py` - 修复图生视频API调用
3. `backend/app/routers/image.py` - 修改API端点,添加状态查询
4. `backend/app/models/schemas.py` - 添加新的响应模型

#### 前端文件 (6个)
1. `frontend/src/App.jsx` - 核心修改:异步轮询、图片传递、自动宽高比
2. `frontend/src/services/api.js` - 添加状态查询API
3. `frontend/src/components/image/ImageGallery.jsx` - 显示任务进度
4. `frontend/src/components/image/ImagePreview.jsx` - 添加prompt展开/收起
5. `frontend/src/components/image/ImagePanel.jsx` - 修改宽高比选择器
6. `frontend/src/components/common/FileUpload.jsx` - 添加宽高比计算

### 代码统计
- 修改文件: 10个
- 新增代码行数: 约400行
- 修改代码行数: 约150行
- 新增功能: 5个

### 测试建议

#### 功能测试
1. **Prompt展开/收起**: 生成带长prompt的图片,预览大图,测试展开/收起
2. **自动宽高比**: 上传不同宽高比的参考图,验证自动识别
3. **图片传递**: 生成图片后点击"生成视频",验证图片正确传递
4. **图生视频**: 使用图生视频模式,验证不再报错
5. **后台运行**: 同时生成多个图片任务,验证并发执行

#### 性能测试
1. 同时生成3个任务(每个2张图片),观察系统负载
2. 测试轮询超时机制(60次后停止)
3. 测试网络中断后的重试机制

#### 边界测试
1. 上传非常大的参考图(>10MB)
2. 输入超长prompt(>2000字符)
3. 快速连续点击生成按钮

---

## Bug修复 - 异步模式图片显示问题

### 问题描述
前端无法正确显示output文件夹中的图片，图片的ratio和prompt字段都是默认值。

### 发现的Bug

#### Bug 1: 前端使用了不存在的字段
**位置**: `frontend/src/App.jsx` 第166-171行

前端代码尝试从 `status.params` 获取 `ratio` 和 `prompt`，但后端 `ImageStatusResponse` 没有 `params` 字段。

#### Bug 2: 后端没有保存prompt到任务
**位置**: `backend/app/services/image_service.py`

`ImageJob` 数据类没有 `prompt` 和 `aspect_ratio` 字段，导致无法在状态响应中返回这些信息。

### 修复内容

#### 1. 后端 ImageJob 添加字段
**文件**: `backend/app/services/image_service.py`

```python
@dataclass
class ImageJob:
    # ... 原有字段 ...
    prompt: str = ""           # 新增
    aspect_ratio: str = "3:2"  # 新增
```

#### 2. 后端创建任务时保存字段
**文件**: `backend/app/services/image_service.py`

```python
job = ImageJob(
    job_id=job_id,
    status=JobStatus.PENDING,
    created_at=time.time(),
    prompt=prompt,              # 新增
    aspect_ratio=aspect_ratio   # 新增
)
```

#### 3. 后端响应模型添加字段
**文件**: `backend/app/models/schemas.py`

```python
class ImageStatusResponse(BaseModel):
    # ... 原有字段 ...
    prompt: str = ""           # 新增
    aspect_ratio: str = "3:2"  # 新增
```

#### 4. 后端路由返回新字段
**文件**: `backend/app/routers/image.py`

```python
return ImageStatusResponse(
    # ... 原有字段 ...
    prompt=job.prompt,              # 新增
    aspect_ratio=job.aspect_ratio   # 新增
)
```

#### 5. 前端使用正确的字段
**文件**: `frontend/src/App.jsx`

```javascript
const newImages = status.images.map((filename, i) => ({
  id: `${Date.now()}-${i}`,
  url: getImageUrl(filename),
  filename,
  ratio: status.aspect_ratio || '3:2',  // 修改: 使用 aspect_ratio
  prompt: status.prompt || '',           // 修改: 使用 prompt
}));
```

### 修改的文件
1. `backend/app/services/image_service.py` - 添加字段到ImageJob
2. `backend/app/models/schemas.py` - 添加字段到ImageStatusResponse
3. `backend/app/routers/image.py` - 返回新字段
4. `frontend/src/App.jsx` - 使用正确的字段名

### 验证方法
1. 启动后端: `cd backend && uv run uvicorn app.main:app --reload --port 8080`
2. 启动前端: `cd frontend && npm run dev`
3. 访问 http://localhost:3000
4. 输入prompt，点击生成
5. 观察控制台是否有错误
6. 验证图片正确显示在画廊中
7. 点击图片预览，验证prompt正确显示

---

## 项目修复 - 安全性与稳定性改进

### 完成内容

1. **路径穿越防护 ✅**
   - 新增 `safe_resolve_path` 工具函数，统一处理文件路径解析
   - 图像/视频下载接口限制扩展名并校验路径安全

2. **阻塞调用降级 ✅**
   - Gemini SDK 调用与文件 IO 全部改为 `asyncio.to_thread` 运行
   - 增加超时限制，避免任务无限挂起

3. **任务与会话清理 ✅**
   - 图像/视频任务增加 TTL 清理逻辑
   - 会话增加活跃时间记录与超时清理

4. **历史记录一致性 ✅**
   - 图像/视频历史记录在生成完成时统一写入
   - 历史读写增加异步锁与原子写入，降低并发损坏风险

5. **错误处理与日志 ✅**
   - 新增统一 500 错误处理，避免泄露内部异常
   - 日志 handler 去重，避免热重载日志重复

6. **前端轮询与内存释放 ✅**
   - 轮询定时器统一管理与清理
   - 上传图片 object URL 及时释放，减少内存泄漏

### 修改文件

#### 后端文件
- `backend/app/utils/error_utils.py` - 新增统一错误处理工具
- `backend/app/utils/file_utils.py` - 安全路径解析与原子写入
- `backend/app/utils/__init__.py` - 导出新增工具
- `backend/app/config.py` - CORS/超时/TTL 配置与日志去重
- `backend/app/main.py` - CORS 配置改为可配置
- `backend/app/services/image_service.py` - 任务清理、线程池调用、历史记录
- `backend/app/services/video_service.py` - 任务清理、线程池调用、历史记录
- `backend/app/services/prompt_service.py` - 延迟初始化与线程池调用
- `backend/app/services/history_service.py` - 异步锁保护历史读写
- `backend/app/routers/image.py` - 安全文件访问与统一错误处理
- `backend/app/routers/video.py` - 安全文件访问与统一错误处理
- `backend/app/routers/history.py` - 统一错误处理

#### 前端文件
- `frontend/src/App.jsx` - 轮询定时器清理与超时保护
- `frontend/src/components/common/FileUpload.jsx` - object URL 释放

### 待测试
- [ ] 图像/视频下载路径安全校验
- [ ] 图像生成与视频生成超时处理
- [ ] 轮询超时后的 UI 提示

---

## Bug修复 - 图生视频 mimeType 缺失

### 问题描述
使用图生视频时报错: `Input instance with image should contain both bytesBase64Encoded and mimeType`.

### 修复内容
- 新增 `decode_base64_to_image_bytes`，将 base64 图像规范化为 PNG 并返回 bytes + mime
- 视频生成改为使用 `types.Image(imageBytes, mimeType)` 传入，避免缺失字段

### 修改文件
- `backend/app/utils/file_utils.py`
- `backend/app/utils/__init__.py`
- `backend/app/services/video_service.py`

---

## Bug修复 - 图生视频日志报错

### 问题描述
视频生成日志引用 `image.mode`，在改为 `types.Image` 后触发 `'Image' object has no attribute 'mode'`。

### 修复内容
- 日志改为输出 `mimeType` 与 `imageBytes` 长度

### 修改文件
- `backend/app/services/video_service.py`

---

## Bug修复 - types.Image 字段名不一致

### 问题描述
日志访问 `image.imageBytes` 导致 `'Image' object has no attribute 'imageBytes'`。

### 修复内容
- 使用实际字段名 `image_bytes` 与 `mime_type`

### 修改文件
- `backend/app/services/video_service.py`
