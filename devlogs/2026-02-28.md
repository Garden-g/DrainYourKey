# 开发日志 - 2026-02-28

## 任务

- 图片生成新增模型切换：`Nano Banana Pro` / `Nano Banana 2`
- 当用户选择 `Nano Banana 2` 时，支持新增分辨率与新增宽高比
- 参数合法性前后端双重校验，避免非法组合提交

## 关键改动

### 后端

- 更新 `backend/app/models/schemas.py`
  - `ImageGenerateRequest` 新增 `image_model` 字段，默认 `nano_banana_pro`
  - `resolution` 扩展为 `0.5K/1K/2K/4K`
  - `ImageStatusResponse` 新增 `image_model` 返回字段
- 更新 `backend/app/routers/image.py`
  - 生成接口将 `image_model` 透传至 service
  - 状态接口返回 `image_model`
- 更新 `backend/app/services/image_service.py`
  - 新增图片模型能力表（模型名、分辨率、宽高比）
  - 新增 `_resolve_image_generation_settings`，做模型能力校验与分辨率映射
  - `0.5K` 在后端映射为 Gemini `image_size=512px`
  - 调用 Gemini 时按 `image_model` 选择真实 provider model：
    - `nano_banana_pro` -> `gemini-3-pro-image-preview`
    - `nano_banana_2` -> `gemini-3.1-flash-image-preview`
  - 历史记录参数新增 `image_model`、`provider_model`、`provider_image_size`

### 前端

- 更新 `frontend/src/components/image/ImagePanel.jsx`
  - 新增“图片模型”下拉（Nano Banana Pro / Nano Banana 2）
  - 分辨率与宽高比按所选模型动态显示
- 更新 `frontend/src/App.jsx`
  - 新增 `imgModel` 状态（默认 `nano_banana_pro`）
  - 模型切换时自动回退不兼容分辨率/宽高比并提示
  - 生成请求新增 `image_model` 参数
  - 生成前增加兜底校验，避免 `auto` 比例导致非法组合
  - 图像任务卡参数补充模型信息
  - 宽高比识别算法新增 `1:4/4:1/1:8/8:1`
- 更新 `frontend/src/components/image/ReferenceImagesUpload.jsx`
  - 自动宽高比识别新增 `1:4/4:1/1:8/8:1`
- 更新 `frontend/src/components/image/ImageJobCard.jsx`
  - 任务卡新增模型标签展示
- 更新 `frontend/src/services/api.js`
  - 图像生成参数注释补充 `image_model` 与 `0.5K -> 512px` 说明

### 文档

- 更新 `README.md`：补充模型切换、分辨率与宽高比能力说明
- 更新 `CONTEXT.md`：补充模型能力映射、关键状态与改动入口

## 验证

- 已完成静态链路检查：`ImagePanel/App -> api.js -> schemas/router/service -> history params`
- 计划执行本地构建/编译检查，确认无语法错误

## 风险与注意事项

- `0.5K` 仅允许 `nano_banana_2` 使用，后端若收到非法组合会返回 400
- `auto` 宽高比在极端参考图下可能生成 Nano Banana 2 专属比例，前端已在提交前兜底回退

---

## 追加任务：专业生图页面与高级参数（同日）

### 任务目标

- 新增“专业生图”功能板块，入口位于“视频生成”下方
- 页面样式参考 `专业模式.html`
- 参数按 Google SDK 可真实生效项落地
- 专业生图与普通图像图库逻辑隔离

### 关键改动

#### 前端

- 更新 `frontend/src/components/layout/Sidebar.jsx`
  - 新增导航项：`专业生图 (pro-image)`
- 更新 `frontend/src/components/layout/Header.jsx`
  - 新增 `pro-image` 标题映射：`专业生图探索`
- 新增 `frontend/src/components/proImage/ProImagePanel.jsx`
  - 新建专业参数面板，包含：
    - 模型/宽高比/分辨率/输出格式/安全过滤
    - Temperature/Top P/Top K/Presence/Frequency/Tokens/Seed
  - 支持随机种子与参数滑杆同步
- 新增 `frontend/src/components/proImage/ProImageGallery.jsx`
  - 新建专业图库展示区（日期头、空态、参数摘要、任务卡、分页加载）
- 更新 `frontend/src/App.jsx`
  - 新增 `pro-image` 页签完整状态流
  - 新增专业图库加载、专业任务提交、专业任务轮询
  - `PromptAssistModal` 在专业页复用 `targetType=image`
  - 普通图像请求固定 `generation_mode=standard`
  - 专业图像请求固定 `generation_mode=pro`
- 更新 `frontend/src/services/api.js`
  - `getImageLibrary` 支持 `generation_mode` 查询参数

#### 后端

- 更新 `backend/app/models/schemas.py`
  - `ImageGenerateRequest` 新增专业参数字段：
    - `generation_mode`
    - `temperature/top_p/top_k/presence_penalty/frequency_penalty/max_output_tokens/seed`
    - `output_mime_type/output_compression_quality`
    - `safety_filter_level`
- 更新 `backend/app/routers/image.py`
  - 生成接口透传所有专业参数到 service
  - 图库接口支持 `generation_mode` 查询
  - 图片文件读取支持 `.png/.jpg/.jpeg`，按后缀返回 MIME
- 更新 `backend/app/services/image_service.py`
  - 新增专业参数到 SDK `GenerateContentConfig` 的统一映射
  - 新增安全过滤等级映射到 `SafetySetting`
  - 支持 PNG/JPEG 输出和 JPEG 自动颜色模式转换
  - 历史记录新增 `generation_mode` 与高级参数快照
- 更新 `backend/app/services/history_service.py`
  - 图库加载支持 `generation_mode` 过滤（standard/pro 隔离）
  - 扫描图片扩展到 `png/jpg/jpeg`

### 验证结果

- 后端编译检查通过：`python -m compileall backend/app`
- 前端构建通过：`npm run build`（Vite build success）

### 风险与注意事项

- 专业页默认隐藏当前链路无法保证生效的参数（如 watermark/person_generation），避免“有控件但不生效”
- 专业图库依赖历史参数中的 `generation_mode` 标记；旧历史未标记数据默认归入 `standard`

### 追加修复：safety_settings 分类兼容（同日）

- 问题：Gemini `generate_content/chats` 不接受 `HARM_CATEGORY_IMAGE_*`，请求会报 `400 INVALID_ARGUMENT`
- 修复：`backend/app/services/image_service.py` 将安全分类降级为通用兼容类别：
  - `HARM_CATEGORY_HATE_SPEECH`
  - `HARM_CATEGORY_HARASSMENT`
  - `HARM_CATEGORY_SEXUALLY_EXPLICIT`
  - `HARM_CATEGORY_DANGEROUS_CONTENT`
- 前端说明：`frontend/src/components/proImage/ProImagePanel.jsx` 在“安全过滤等级”下新增兼容提示文案

### 追加修复：types.Image 保存参数不兼容（同日）

- 问题：`part.as_image()` 返回 `google.genai.types.Image`，其 `save()` 仅支持 `save(location)`，不支持 `format` 参数
- 现象：报错 `Image.save() got an unexpected keyword argument 'format'`
- 修复：`backend/app/services/image_service.py` 的 `_save_generated_image` 改为：
  - 读取 `image.image_bytes`
  - 使用 Pillow `PIL.Image.open(BytesIO(...))` 重编码保存
  - JPEG 场景执行 `RGBA -> RGB` 转换并应用 `quality`
  - 无 `image_bytes` 时回退到 `image.save(location)`
