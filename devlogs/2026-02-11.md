# 开发日志 - 2026-02-11

## 任务

- 图像生成板块新增：参考图支持拖拽上传
- 图像生成板块新增：参考图支持多图上传（不再限制单图）

## 关键改动

### 前端

- 新增 `frontend/src/components/image/ReferenceImagesUpload.jsx`
  - 支持点击选择与拖拽上传
  - 支持一次选择多张并追加到现有列表
  - 支持删除单张和清空全部
  - 自动计算每张图的宽高比并保存到状态
  - 参考图数量上限设置为 14
- 更新 `frontend/src/components/image/ImagePanel.jsx`
  - 单图上传切换为多图上传组件
  - 宽高比 `auto` 改为读取第 1 张参考图比例
  - 生成按钮禁用条件改为检查多图数组
- 更新 `frontend/src/App.jsx`
  - `imgReference` 改为 `imgReferences`
  - 图像生成请求新增 `reference_images`，并兼容保留 `reference_image`
- 更新 `frontend/src/services/api.js`
  - 图像生成参数注释补充 `reference_images`

### 后端

- 更新 `backend/app/models/schemas.py`
  - `ImageGenerateRequest` 新增 `reference_images`（最多 14 张）
  - 保留 `reference_image` 兼容旧调用
- 更新 `backend/app/routers/image.py`
  - 生成接口向 service 传递 `reference_images`
  - 新增 `ValueError` -> 400 的请求错误处理
- 更新 `backend/app/services/image_service.py`
  - 新增 `_normalize_reference_images` 统一兼容新旧字段并去重
  - 多图按顺序加入 Gemini `contents`
  - 增加参考图数量日志与历史参数 `reference_image_count`

### 文档

- 更新 `CONTEXT.md`：补充多图上传组件、状态和校验点
- 更新 `README.md`：补充多参考图能力及新参数说明

## 验证

- 已完成静态代码检查与改动链路核对（前端状态 -> API -> 后端 schema -> service）
- 尚未在本机启动前后端进行手工联调（可在下一步执行）

## 风险与注意事项

- 多图 base64 会增大请求体，超大图建议先压缩后上传
- 当前 `POST /api/image/generate` 仍要求 `prompt` 非空（模型层保持现有约束）
